<!DOCTYPE html>
<html lang="ja"><head>

<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<title>ãƒªã‚ºãƒ ãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° Lab Ver.9</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&amp;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@40,700,1,0" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #FDF2F8;
            background-image: radial-gradient(#FBCFE8 2px, transparent 2px);
            background-size: 24px 24px;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border: 2px solid white;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        @keyframes bounce-sm {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-sm { animation: bounce-sm 2s infinite; }
        ::-webkit-scrollbar { height: 12px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 6px; }
        ::-webkit-scrollbar-thumb { background: #DB2777; border-radius: 6px; }
        
        /* ã‚²ãƒ¼ãƒ ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .cell-base {
            background-color: #FDF2F8; /* è–„ã„ãƒ”ãƒ³ã‚¯ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) */
            border: 1px solid #FBCFE8;
        }
        .cell-target-active {
            background-color: #EC4899 !important; /* Pink-500 (æ­£è§£ã®å ´æ‰€) */
            box-shadow: 0 0 10px #EC4899;
            border-color: #FBCFE8 !important;
        }
        .cell-cursor {
            border: 2px solid white !important;
            background-color: rgba(255, 255, 255, 0.4) !important; /* ã‚«ãƒ¼ã‚½ãƒ«ä½ç½® */
            z-index: 10;
            transform: scale(1.05);
        }
        .cell-hit-success {
            background-color: #4ADE80 !important; /* Green-400 (æ­£è§£ãƒ’ãƒƒãƒˆ) */
            box-shadow: 0 0 15px #4ADE80;
            border-color: white !important;
            transform: scale(1.1);
        }
        .cell-hit-fail {
            background-color: #EF4444 !important; /* Red-500 (é–“é•ã„ãƒ’ãƒƒãƒˆ) */
            box-shadow: 0 0 15px #EF4444;
            border-color: white !important;
            transform: scale(0.9);
        }
    </style></head>
<body class="text-slate-700 min-h-screen flex flex-col selection:bg-pink-200">
<!-- Header -->
<header class="bg-white border-b-4 border-pink-200 px-6 py-4 flex justify-between items-center z-20 shadow-sm sticky top-0">
<div class="flex items-center gap-3">
<div class="bg-pink-500 text-white p-2 rounded-2xl shadow-[0_4px_0_#be185d] transform -rotate-3">
<span class="material-symbols-rounded text-3xl block">piano</span>
</div>
<div>
<h1 class="text-xl md:text-2xl font-black tracking-wider text-slate-800">ãƒªã‚ºãƒ ãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° Lab</h1>
</div>
</div>
<div class="flex gap-2">
<div class="flex bg-slate-100 p-1 rounded-2xl border-2 border-slate-200 mr-2">
<button class="px-4 py-2 rounded-xl text-sm font-bold text-slate-400 hover:text-slate-600 transition-all" id="tab-maker" onclick="switchMainTab('maker')">
<span class="flex items-center gap-1"><span class="material-symbols-rounded">build</span> ã¤ãã‚‹</span>
</button>
<button class="px-4 py-2 rounded-xl text-sm font-bold transition-all bg-white text-blue-500 shadow-sm" id="tab-game" onclick="switchMainTab('game')">
<span class="flex items-center gap-1"><span class="material-symbols-rounded">sports_esports</span> ã‚²ãƒ¼ãƒ </span>
</button>
</div>
<button class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-2 rounded-2xl font-bold flex items-center gap-2 shadow-[0_4px_0_#ca8a04] active:shadow-none active:translate-y-1 transition-all" onclick="openHelp()">
<span class="material-symbols-rounded">help</span>
</button>
<button class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded-2xl font-bold flex items-center gap-2 shadow-[0_4px_0_#1e293b] active:shadow-none active:translate-y-1 transition-all" onclick="downloadSource()">
<span class="material-symbols-rounded">save</span>
</button>
</div>
</header>
<!-- Main Content -->
<main class="flex-1 w-full max-w-6xl mx-auto p-4 md:p-8 flex flex-col gap-6 relative">
<!-- VIEW: MAKER -->
<div class="flex flex-col gap-6 w-full transition-opacity duration-300 hidden" id="view-maker">
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="glass-panel p-6 rounded-3xl flex items-center gap-6 justify-center md:justify-start">
<button class="bg-pink-500 hover:bg-pink-600 text-white w-20 h-20 rounded-full shadow-[0_6px_0_#be185d] flex items-center justify-center transition-transform hover:scale-105 active:scale-95 active:shadow-none active:translate-y-1.5 flex-shrink-0" id="play-btn" onclick="togglePlay()">
<span class="material-symbols-rounded text-5xl ml-1" id="play-icon">play_arrow</span>
</button>
<div class="flex-1">
<div class="bg-white px-4 py-2 rounded-2xl border-2 border-slate-100 flex flex-col justify-center shadow-sm mb-3">
<span class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">ã¯ã‚„ã•</span>
<div class="flex items-center gap-3">
<span class="material-symbols-rounded text-slate-400">speed</span>
<input class="w-full accent-pink-500 cursor-pointer" max="240" min="60" oninput="updateTempo(this.value)" type="range" value="120">
<span class="font-mono font-bold text-xl text-pink-600 w-12 text-center" id="tempo-display">120</span>
</div>
</div>
<div class="flex justify-end">
<button class="text-xs font-bold text-slate-400 hover:text-red-500 flex items-center gap-1 transition px-2 py-1 rounded hover:bg-slate-100" onclick="clearBeats()">
<span class="material-symbols-rounded text-sm">delete</span> å…¨éƒ¨ã‘ã™
                        </button>
</div>
</div>
</div>
<div class="glass-panel p-6 rounded-3xl flex flex-col gap-4">
<div>
<span class="text-xs font-bold text-slate-400 uppercase tracking-widest block mb-2">ãŠæ‰‹æœ¬ãƒªã‚ºãƒ </span>
<div class="flex flex-wrap gap-2">
<button class="px-3 py-2 rounded-xl bg-blue-100 text-blue-600 font-bold hover:bg-blue-200 transition text-sm flex items-center gap-1" onclick="loadPreset('rock')">âš¡ï¸ 8ãƒ“ãƒ¼ãƒˆ</button>
<button class="px-3 py-2 rounded-xl bg-purple-100 text-purple-600 font-bold hover:bg-purple-200 transition text-sm flex items-center gap-1" onclick="loadPreset('dance')">ğŸ’ƒ ãƒ€ãƒ³ã‚¹</button>
<button class="px-3 py-2 rounded-xl bg-orange-100 text-orange-600 font-bold hover:bg-orange-200 transition text-sm flex items-center gap-1" onclick="loadPreset('hiphop')">ğŸ˜ ãƒ’ãƒƒãƒ—ãƒ›ãƒƒãƒ—</button>
<button class="px-3 py-2 rounded-xl bg-green-100 text-green-600 font-bold hover:bg-green-200 transition text-sm flex items-center gap-1" onclick="loadPreset('latin')">ğŸ ãƒ©ãƒ†ãƒ³</button>
</div>
</div>
<div class="border-t-2 border-slate-100 pt-3">
<span class="text-xs font-bold text-pink-400 uppercase tracking-widest block mb-2">ãƒã‚¤ãƒ«ãƒ¼ãƒ </span>
<div class="flex gap-2 mb-3">
<input class="flex-1 bg-white border-2 border-slate-200 rounded-xl px-3 py-2 text-sm font-bold focus:outline-none focus:border-pink-400" id="preset-name" placeholder="ãƒªã‚ºãƒ ã®ãªã¾ãˆ" type="text">
<button class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-md active:scale-95 transition" onclick="saveUserPreset()">ä¿å­˜</button>
</div>
<div class="flex flex-wrap gap-2 max-h-24 overflow-y-auto" id="user-preset-list">
<span class="text-xs text-slate-400 italic py-1">ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
</div>
</div>
</div>
</div>
<div class="bg-slate-800 rounded-3xl shadow-2xl p-6 overflow-hidden relative flex-1 flex flex-col justify-center min-h-[400px]">
<div class="w-full overflow-x-auto pb-4">
<div class="w-full max-w-6xl mx-auto px-2">
<div class="flex gap-2 mb-3 pl-[100px]" id="step-indicators"><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-0"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-1"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-2"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 mr-4" id="ind-3"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-4"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-5"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-6"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 mr-4" id="ind-7"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-8"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-9"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-10"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 mr-4" id="ind-11"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-12"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-13"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-14"></div><div class="w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 " id="ind-15"></div></div>
<div class="space-y-3" id="sequencer-rows"><div class="flex items-center gap-3 bg-slate-700/30 p-2 rounded-xl border border-slate-700 hover:border-slate-600 transition group relative pr-12"><div class="w-[80px] flex flex-col items-center justify-center text-yellow-400 cursor-help transition transform group-hover:scale-105" onclick="playOneShot('hihat')"><span class="material-symbols-rounded text-3xl">album</span><span class="text-[10px] font-bold mt-1">ãƒãƒƒãƒˆ</span></div><div class="flex gap-2 flex-1" id="row-hihat"><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="0"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="1"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="2"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="hihat" data-i="3"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="4"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="5"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="6"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="hihat" data-i="7"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="8"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="9"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="10"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="hihat" data-i="11"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="12"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="13"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="14"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="hihat" data-i="15"></div></div><button class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-red-400 p-1.5 rounded hover:bg-slate-700 transition opacity-50 group-hover:opacity-100" onclick="clearRow('hihat')"><span class="material-symbols-rounded">backspace</span></button></div><div class="flex items-center gap-3 bg-slate-700/30 p-2 rounded-xl border border-slate-700 hover:border-slate-600 transition group relative pr-12"><div class="w-[80px] flex flex-col items-center justify-center text-green-400 cursor-help transition transform group-hover:scale-105" onclick="playOneShot('clap')"><span class="material-symbols-rounded text-3xl js-replaced-missing-icon">radio_button_unchecked</span><span class="text-[10px] font-bold mt-1">ã‚¯ãƒ©ãƒƒãƒ—</span></div><div class="flex gap-2 flex-1" id="row-clap"><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="0"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="1"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="2"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="clap" data-i="3"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="4"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="5"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="6"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="clap" data-i="7"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="8"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="9"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="10"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="clap" data-i="11"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="12"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="13"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="14"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="clap" data-i="15"></div></div><button class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-red-400 p-1.5 rounded hover:bg-slate-700 transition opacity-50 group-hover:opacity-100" onclick="clearRow('clap')"><span class="material-symbols-rounded">backspace</span></button></div><div class="flex items-center gap-3 bg-slate-700/30 p-2 rounded-xl border border-slate-700 hover:border-slate-600 transition group relative pr-12"><div class="w-[80px] flex flex-col items-center justify-center text-cyan-400 cursor-help transition transform group-hover:scale-105" onclick="playOneShot('snare')"><span class="material-symbols-rounded text-3xl">adjust</span><span class="text-[10px] font-bold mt-1">ã‚¹ãƒã‚¢</span></div><div class="flex gap-2 flex-1" id="row-snare"><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="0"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="1"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="2"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="snare" data-i="3"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="4"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="5"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="6"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="snare" data-i="7"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="8"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="9"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="10"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="snare" data-i="11"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="12"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="13"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="14"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="snare" data-i="15"></div></div><button class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-red-400 p-1.5 rounded hover:bg-slate-700 transition opacity-50 group-hover:opacity-100" onclick="clearRow('snare')"><span class="material-symbols-rounded">backspace</span></button></div><div class="flex items-center gap-3 bg-slate-700/30 p-2 rounded-xl border border-slate-700 hover:border-slate-600 transition group relative pr-12"><div class="w-[80px] flex flex-col items-center justify-center text-purple-400 cursor-help transition transform group-hover:scale-105" onclick="playOneShot('tom')"><span class="material-symbols-rounded text-3xl">trip_origin</span><span class="text-[10px] font-bold mt-1">ã‚¿ãƒ </span></div><div class="flex gap-2 flex-1" id="row-tom"><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="0"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="1"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="2"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="tom" data-i="3"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="4"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="5"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="6"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="tom" data-i="7"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="8"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="9"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="10"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="tom" data-i="11"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="12"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="13"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="14"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="tom" data-i="15"></div></div><button class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-red-400 p-1.5 rounded hover:bg-slate-700 transition opacity-50 group-hover:opacity-100" onclick="clearRow('tom')"><span class="material-symbols-rounded">backspace</span></button></div><div class="flex items-center gap-3 bg-slate-700/30 p-2 rounded-xl border border-slate-700 hover:border-slate-600 transition group relative pr-12"><div class="w-[80px] flex flex-col items-center justify-center text-pink-400 cursor-help transition transform group-hover:scale-105" onclick="playOneShot('kick')"><span class="material-symbols-rounded text-3xl">circle</span><span class="text-[10px] font-bold mt-1">ãƒã‚¹ãƒ‰ãƒ©</span></div><div class="flex gap-2 flex-1" id="row-kick"><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="0"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="1"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="2"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="kick" data-i="3"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="4"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="5"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="6"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="kick" data-i="7"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="8"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="9"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="10"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 mr-4" data-t="kick" data-i="11"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="12"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="13"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="14"></div><div class="w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 " data-t="kick" data-i="15"></div></div><button class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-red-400 p-1.5 rounded hover:bg-slate-700 transition opacity-50 group-hover:opacity-100" onclick="clearRow('kick')"><span class="material-symbols-rounded">backspace</span></button></div></div>
</div>
</div>
<div class="mt-4 text-center">
<p class="text-slate-400 text-sm font-bold flex items-center justify-center gap-2">
<span class="material-symbols-rounded text-yellow-400 text-base animate-bounce-sm">lightbulb</span>
                    ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©¦è´ã€å³ã®<span class="material-symbols-rounded text-sm bg-slate-600 px-1 rounded">backspace</span>ã§åˆ—ã‚’ã‚¯ãƒªã‚¢
                </p>
</div>
</div>
</div>
<!-- VIEW: GAME -->
<div class="flex flex-col gap-6 w-full h-full min-h-[600px]" id="view-game">
<div class="w-full h-full flex flex-col items-center justify-center gap-8 py-8 animate-fade-in hidden" id="game-menu">
<div class="text-center">
<span class="bg-yellow-100 text-yellow-700 px-4 py-1 rounded-full font-black text-sm mb-4 inline-block">NEW GAME</span>
<h2 class="text-4xl md:text-5xl font-black text-slate-800 mb-4">ãƒªã‚ºãƒ ãƒ»ãƒ¡ãƒ¢ãƒªãƒ¼</h2>
<p class="text-slate-500 font-bold text-lg">ãƒ”ãƒ³ã‚¯ã®å ´æ‰€ã‚’è¦šãˆã¦ã€åŒã˜ãƒªã‚ºãƒ ã‚’å©ã“ã†ï¼</p>
</div>
<div class="bg-white p-8 rounded-3xl shadow-xl border-4 border-pink-100 max-w-lg w-full text-center">
<div class="flex justify-center gap-8 mb-8 items-center">
<div class="text-center">
<div class="bg-slate-800 p-3 rounded-xl mb-2"><span class="material-symbols-rounded text-pink-400 text-3xl">visibility</span></div>
<span class="text-xs font-bold text-slate-400">1. ã¿ã‚‹</span>
</div>
<span class="material-symbols-rounded text-slate-300">arrow_forward</span>
<div class="text-center">
<div class="bg-slate-800 p-3 rounded-xl mb-2"><span class="material-symbols-rounded text-green-400 text-3xl">touch_app</span></div>
<span class="text-xs font-bold text-slate-400">2. ãŸãŸã</span>
</div>
</div>
<button class="bg-pink-500 hover:bg-pink-600 text-white px-12 py-4 rounded-full font-black text-2xl shadow-[0_6px_0_#be185d] active:shadow-none active:translate-y-2 transition transform hover:scale-105 w-full" onclick="gameStart()">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
</div>
</div>
<div class="w-full h-full bg-slate-900 rounded-3xl relative overflow-hidden flex flex-col items-center justify-between p-6 md:p-12" id="game-play">
<div class="w-full flex justify-between items-center">
<button class="text-slate-400 hover:text-white flex items-center gap-2 font-bold transition" onclick="exitGame()">
<span class="material-symbols-rounded">arrow_back</span> ã‚„ã‚ã‚‹
            </button>
<div class="text-white font-black text-xl">Level <span class="text-yellow-400 text-2xl" id="game-level">1</span></div>
</div>
<div class="flex-1 flex flex-col justify-center w-full max-w-3xl gap-8">
<div class="h-16 flex items-center justify-center">
<div class="text-3xl md:text-5xl font-black text-white animate-bounce" id="game-message">Go!</div>
</div>
<div class="bg-slate-800/50 p-6 rounded-3xl border border-slate-700 backdrop-blur-sm">
<div class="flex items-center gap-4 mb-6">
<div class="w-24 text-right font-bold text-pink-400 text-sm md:text-base">ãŠæ‰‹æœ¬</div>
<div class="flex-1 flex gap-1 md:gap-2" id="game-row-demo"><div class="w-full h-12 rounded-lg border transition-all duration-100 cell-target-active" id="g-demo-0"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-1"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-2"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-3"></div><div class="w-full h-12 rounded-lg border transition-all duration-100 cell-target-active" id="g-demo-4"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-5"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-6"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-7"></div><div class="w-full h-12 rounded-lg border transition-all duration-100 cell-target-active" id="g-demo-8"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-9"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-10"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-11"></div><div class="w-full h-12 rounded-lg border transition-all duration-100 cell-target-active" id="g-demo-12"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-13"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-14"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600" id="g-demo-15"></div></div>
</div>
<div class="flex items-center gap-4">
<div class="w-24 text-right font-bold text-green-400 text-sm md:text-base">ã‚ãªãŸ</div>
<div class="flex-1 flex gap-1 md:gap-2" id="game-row-player"><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-0"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100 cell-cursor" id="g-player-1"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-2"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-3"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-4"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-5"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-6"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-7"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-8"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-9"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-10"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-11"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-12"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-13"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-14"></div><div class="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100" id="g-player-15"></div></div>
</div>
</div>
<div class="text-center text-slate-400 text-sm font-bold h-6" id="game-instruction">ç™½ã„æ ã«ã‚ã‚ã›ã¦ TAPï¼</div>
</div>
<div class="w-full max-w-md h-32 relative">
<button class="w-full h-full bg-gradient-to-b from-green-400 to-green-600 rounded-2xl shadow-[0_8px_0_#15803d] active:shadow-none active:translate-y-2 transition-all flex items-center justify-center group disabled:opacity-50 disabled:cursor-not-allowed" id="game-tap-btn" onmousedown="gameTap()" ontouchstart="event.preventDefault(); gameTap()">
<div class="flex flex-col items-center text-white group-active:scale-95 transition">
<span class="material-symbols-rounded text-5xl">touch_app</span>
<span class="font-black text-xl tracking-widest mt-1">TAP!</span>
</div>
</button>
</div>
</div>
<div class="absolute inset-0 bg-slate-900/90 z-50 flex flex-col items-center justify-center p-4 animate-fade-in hidden" id="game-result">
<span class="material-symbols-rounded text-8xl text-slate-400 mb-4" id="result-icon">sentiment_dissatisfied</span>
<h2 class="text-4xl md:text-6xl font-black text-white mb-2" id="result-title">Try Again...</h2>
<p class="text-slate-300 font-bold text-xl mb-8" id="result-desc">Score: 30ç‚¹</p>
<button class="bg-pink-500 hover:bg-pink-600 text-white px-10 py-3 rounded-full font-black text-xl shadow-lg hover:scale-105 transition" onclick="gameNextLevel()">ã‚‚ã†ã„ã¡ã©</button>
</div>
</div>
</main>
<div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300 hidden opacity-0" id="help-modal">
<div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden transform transition-all scale-95" id="help-content">
<div class="bg-yellow-400 p-4 flex justify-between items-center">
<h2 class="text-xl font-black text-white flex items-center gap-2"><span class="material-symbols-rounded">school</span> ã‚ãã³ã‹ãŸ</h2>
<button class="bg-white/20 hover:bg-white/40 text-white rounded-full p-1 transition" onclick="closeHelp()"><span class="material-symbols-rounded">close</span></button>
</div>
<div class="p-6 space-y-6 overflow-y-auto max-h-[70vh]">
<div class="flex gap-4 items-start">
<div class="bg-pink-100 text-pink-600 w-8 h-8 rounded-full flex items-center justify-center font-black text-lg flex-shrink-0">1</div>
<div>
<h3 class="text-lg font-bold text-slate-800 mb-1">ã¤ãã‚‹</h3>
<p class="text-sm text-slate-600">ãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒªã‚ºãƒ ã‚’ä½œã‚ã†ã€‚å³ä¸Šã®ä¿å­˜ãƒœã‚¿ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã§ãã‚‹ã‚ˆã€‚</p>
</div>
</div>
<div class="flex gap-4 items-start">
<div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center font-black text-lg flex-shrink-0">2</div>
<div>
<h3 class="text-lg font-bold text-slate-800 mb-1">ã‚²ãƒ¼ãƒ </h3>
<p class="text-sm text-slate-600">ãƒ”ãƒ³ã‚¯ã«å…‰ã‚‹ãŠæ‰‹æœ¬ãƒªã‚ºãƒ ã‚’è¦šãˆã¦ã€ç™½ã„æ ãŒé‡ãªã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¿ãƒƒãƒ—ã—ã‚ˆã†ï¼æ­£è§£ãªã‚‰ç·‘ã€é–“é•ã„ãªã‚‰èµ¤ã«ãªã‚‹ã‚ˆã€‚</p>
</div>
</div>
<div class="bg-slate-50 p-4 flex justify-center">
<button class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-xl font-bold shadow-sm active:translate-y-0.5 transition w-full" onclick="closeHelp()">ã‚ã‹ã£ãŸï¼</button>
</div>
</div>
</div>
</div>
<script>
    /* UTILS & TABS */
    function downloadSource() {
        const html = document.documentElement.outerHTML;
        const blob = new Blob([html], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'rhythm-lab-final-fixed.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    function switchMainTab(tabId) {
        if(isPlaying) togglePlay(); if(gameActive) exitGame();
        const m = document.getElementById('view-maker'), g = document.getElementById('view-game');
        const mt = document.getElementById('tab-maker'), gt = document.getElementById('tab-game');
        if(tabId==='maker') { m.classList.remove('hidden'); g.classList.add('hidden'); mt.className="px-4 py-2 rounded-xl text-sm font-bold transition-all bg-white text-pink-500 shadow-sm"; gt.className="px-4 py-2 rounded-xl text-sm font-bold text-slate-400 hover:text-slate-600 transition-all"; }
        else { m.classList.add('hidden'); g.classList.remove('hidden'); gt.className="px-4 py-2 rounded-xl text-sm font-bold transition-all bg-white text-blue-500 shadow-sm"; mt.className="px-4 py-2 rounded-xl text-sm font-bold text-slate-400 hover:text-slate-600 transition-all"; }
    }
    const modal=document.getElementById('help-modal'), mCnt=document.getElementById('help-content');
    function openHelp(){modal.classList.remove('hidden');void modal.offsetWidth;modal.classList.remove('opacity-0');mCnt.classList.remove('scale-95');mCnt.classList.add('scale-100');}
    function closeHelp(){modal.classList.add('opacity-0');mCnt.classList.remove('scale-100');mCnt.classList.add('scale-95');setTimeout(()=>{modal.classList.add('hidden')},300);}

    /* AUDIO */
    const STEPS=16; let isPlaying=false, currentStep=0, tempo=120;
    const INSTRUMENTS=['hihat','clap','snare','tom','kick'];
    let grid={hihat:Array(STEPS).fill(0),clap:Array(STEPS).fill(0),snare:Array(STEPS).fill(0),tom:Array(STEPS).fill(0),kick:Array(STEPS).fill(0)};
    let synths={}, isAudioInit=false;
    async function initAudio(){
        if(isAudioInit) return; await Tone.start();
        synths.kick = new Tone.MembraneSynth().toDestination();
        synths.snare = new Tone.NoiseSynth({noise:{type:'white'},envelope:{decay:0.1}}).toDestination();
        synths.hihat = new Tone.MetalSynth({harmonicity:5.1,modulationIndex:32}).toDestination(); synths.hihat.volume.value=-15;
        synths.clap = new Tone.NoiseSynth({noise:{type:'pink'},envelope:{decay:0.1}}).toDestination(); synths.clap.volume.value=-10;
        synths.tom = new Tone.MembraneSynth({pitchDecay:0.05,octaves:4}).toDestination();
        synths.metro = new Tone.MembraneSynth().toDestination(); synths.metro.volume.value=-15;
        isAudioInit=true;
    }
    function playOneShot(t){initAudio().then(()=>{
        if(t==='kick')synths.kick.triggerAttackRelease("C1","8n");if(t==='snare')synths.snare.triggerAttackRelease("8n");
        if(t==='hihat')synths.hihat.triggerAttackRelease("32n");if(t==='clap')synths.clap.triggerAttackRelease("8n");
        if(t==='tom')synths.tom.triggerAttackRelease("G2","8n");if(t==='metro')synths.metro.triggerAttackRelease("C6","32n");
    });}

    /* MAKER */
    function initGrid(){
        const inds=document.getElementById('step-indicators'), rows=document.getElementById('sequencer-rows');
        inds.innerHTML=''; rows.innerHTML='';
        for(let i=0;i<STEPS;i++){
            const m=(i+1)%4===0&&i!==15?'mr-4':'';
            const d=document.createElement('div');d.className=`w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 ${m}`;d.id=`ind-${i}`;inds.appendChild(d);
        }
        const iData={hihat:{c:'yellow',i:'album',l:'ãƒãƒƒãƒˆ'},clap:{c:'green',i:'hands_clapping',l:'ã‚¯ãƒ©ãƒƒãƒ—'},snare:{c:'cyan',i:'adjust',l:'ã‚¹ãƒã‚¢'},tom:{c:'purple',i:'trip_origin',l:'ã‚¿ãƒ '},kick:{c:'pink',i:'circle',l:'ãƒã‚¹ãƒ‰ãƒ©'}};
        INSTRUMENTS.forEach(inst=>{
            const d=document.createElement('div');d.className=`flex items-center gap-3 bg-slate-700/30 p-2 rounded-xl border border-slate-700 hover:border-slate-600 transition group relative pr-12`;
            d.innerHTML=`<div class="w-[80px] flex flex-col items-center justify-center text-${iData[inst].c}-400 cursor-help transition transform group-hover:scale-105" onclick="playOneShot('${inst}')"><span class="material-symbols-rounded text-3xl">${iData[inst].i}</span><span class="text-[10px] font-bold mt-1">${iData[inst].l}</span></div><div class="flex gap-2 flex-1" id="row-${inst}"></div><button class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-red-400 p-1.5 rounded hover:bg-slate-700 transition opacity-50 group-hover:opacity-100" onclick="clearRow('${inst}')"><span class="material-symbols-rounded">backspace</span></button>`;
            rows.appendChild(d);
            const cbr=d.querySelector(`#row-${inst}`);
            for(let i=0;i<STEPS;i++){
                const m=(i+1)%4===0&&i!==15?'mr-4':'';
                const c=document.createElement('div');
                c.className=`w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all duration-100 border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 ${m}`;
                c.dataset.t=inst;c.dataset.i=i;c.onclick=()=>toggleNote(inst,i,c);
                cbr.appendChild(c);
            }
        });
    }
    function toggleNote(t,i,e){initAudio();grid[t][i]=grid[t][i]?0:1;renderCell(t,i,e);if(grid[t][i])playOneShot(t);}
    function renderCell(t,i,e){
        const a=grid[t][i];
        const c={kick:'bg-pink-500 border-pink-400 shadow-[0_0_10px_#ec4899]',snare:'bg-cyan-500 border-cyan-400 shadow-[0_0_10px_#06b6d4]',hihat:'bg-yellow-400 border-yellow-300 shadow-[0_0_10px_#eab308]',clap:'bg-green-500 border-green-400 shadow-[0_0_10px_#22c55e]',tom:'bg-purple-500 border-purple-400 shadow-[0_0_10px_#a855f7]'};
        const m=(i+1)%4===0&&i!==15?'mr-4':'';
        if(a)e.className=`w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all border scale-105 ${c[t]} flex-shrink-0 ${m}`;
        else e.className=`w-8 h-10 md:w-10 md:h-14 rounded-lg cursor-pointer transition-all border border-slate-600 bg-slate-900 hover:bg-slate-700 flex-shrink-0 ${m}`;
    }
    function clearRow(t){grid[t].fill(0);const cs=document.querySelectorAll(`#row-${t} > div`);cs.forEach((e,i)=>renderCell(t,i,e));}
    function togglePlay(){
        initAudio().then(()=>{
            isPlaying=!isPlaying; const ic=document.getElementById('play-icon'),bt=document.getElementById('play-btn');
            if(isPlaying){ic.textContent='stop';bt.className="bg-slate-700 hover:bg-slate-800 text-white w-20 h-20 rounded-full shadow-inner flex items-center justify-center transition-transform scale-95 flex-shrink-0";Tone.Transport.bpm.value=tempo;Tone.Transport.scheduleRepeat(playStep,"16n");Tone.Transport.start();}
            else{ic.textContent='play_arrow';bt.className="bg-pink-500 hover:bg-pink-600 text-white w-20 h-20 rounded-full shadow-[0_6px_0_#be185d] flex items-center justify-center transition-transform hover:scale-105 active:scale-95 active:shadow-none active:translate-y-1.5 flex-shrink-0";Tone.Transport.stop();Tone.Transport.cancel();currentStep=0;resetVisuals();}
        });
    }
    function playStep(t){
        Tone.Draw.schedule(()=>{updateStepVisuals(currentStep)},t);
        if(grid.kick[currentStep])synths.kick.triggerAttackRelease("C1","8n",t);if(grid.snare[currentStep])synths.snare.triggerAttackRelease("8n",t);if(grid.hihat[currentStep])synths.hihat.triggerAttackRelease("32n",t);if(grid.clap[currentStep])synths.clap.triggerAttackRelease("8n",t);if(grid.tom[currentStep])synths.tom.triggerAttackRelease("G2","8n",t);
        currentStep=(currentStep+1)%STEPS;
    }
    function updateStepVisuals(s){
        const p=(s-1+STEPS)%STEPS, pe=document.getElementById(`ind-${p}`), pm=(p+1)%4===0&&p!==15?'mr-4':'';
        if(pe)pe.className=`w-8 h-2 md:w-10 rounded-full bg-slate-700 transition-colors flex-shrink-0 ${pm}`;
        const ce=document.getElementById(`ind-${s}`), cm=(s+1)%4===0&&s!==15?'mr-4':'';
        if(ce)ce.className=`w-8 h-2 md:w-10 rounded-full bg-white shadow-[0_0_10px_white] scale-110 flex-shrink-0 ${cm}`;
    }
    function resetVisuals(){for(let i=0;i<STEPS;i++)updateStepVisuals((i+1)%STEPS);}
    function updateTempo(v){tempo=v;document.getElementById('tempo-display').textContent=v;if(isPlaying)Tone.Transport.bpm.rampTo(v,0.1);}
    function clearBeats(){INSTRUMENTS.forEach(inst=>clearRow(inst));}
    const PRESETS={rock:{kick:[1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1]},dance:{kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0]},hiphop:{kick:[1,0,0,0,0,0,1,0,0,0,1,1,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[1,0,1,0,1,0,1,0,1,0,0,1,1,0,1,0]},latin:{kick:[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0],clap:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0],tom:[1,0,0,0,0,1,0,0,1,0,0,0,0,0,0,1]}};
    function loadPreset(n){initAudio();const p=PRESETS[n];if(!p)return;INSTRUMENTS.forEach(i=>{grid[i]=p[i]?[...p[i]]:Array(STEPS).fill(0);const cs=document.querySelectorAll(`#row-${i} > div`);cs.forEach((e,ix)=>renderCell(i,ix,e));});playOneShot('hihat');}
    let userPresets=[];
    function saveUserPreset(){const n=document.getElementById('preset-name').value.trim()||`ãƒªã‚ºãƒ  ${userPresets.length+1}`;const d={};INSTRUMENTS.forEach(i=>d[i]=[...grid[i]]);userPresets.push({name:n,data:d});document.getElementById('preset-name').value='';renderUPL();playOneShot('clap');}
    function renderUPL(){const c=document.getElementById('user-preset-list');c.innerHTML=userPresets.length===0?'<span class="text-xs text-slate-400 italic py-1">ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“</span>':'';userPresets.forEach((p,x)=>{const b=document.createElement('button');b.className="px-3 py-1 bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-600 hover:bg-pink-50 hover:border-pink-300 hover:text-pink-500 transition flex items-center gap-1 whitespace-nowrap";b.innerHTML=`<span class="material-symbols-rounded text-xs">music_note</span> ${p.name}`;b.onclick=()=>{INSTRUMENTS.forEach(i=>{grid[i]=p.data[i]?[...p.data[i]]:Array(STEPS).fill(0);const cs=document.querySelectorAll(`#row-${i} > div`);cs.forEach((e,ix)=>renderCell(i,ix,e));});playOneShot('hihat');};c.appendChild(b);});}

    /* GAME LOGIC */
    let gameActive=false, gameLevel=1, gamePhase='idle', gameUserPos=0, gameUserScore=0;
    const GAME_STEPS=16;
    const GAME_LEVELS=[
        [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0],
        [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0],
        [1,0,0,1, 0,0,1,0, 1,0,0,1, 0,0,1,0],
        [1,1,0,1, 0,1,0,0, 1,0,1,1, 0,0,1,0],
        [0,1,1,0, 1,0,0,1, 0,1,1,0, 1,0,0,1]
    ];
    let gameSequence=null;
    let countdownTimer=null;

    function initGameUI(){
        const dr=document.getElementById('game-row-demo'), pr=document.getElementById('game-row-player');
        dr.innerHTML=''; pr.innerHTML='';
        for(let i=0;i<GAME_STEPS;i++){
            const d=document.createElement('div'), p=document.createElement('div');
            d.className="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100"; d.id=`g-demo-${i}`;
            p.className="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100"; p.id=`g-player-${i}`;
            dr.appendChild(d); pr.appendChild(p);
        }
    }

    function gameStart(){initAudio();gameActive=true;gameLevel=1;document.getElementById('game-menu').classList.add('hidden');document.getElementById('game-play').classList.remove('hidden');document.getElementById('game-result').classList.add('hidden');initGameUI();startLevel(0);}

    function startLevel(lx){
        if(countdownTimer){clearInterval(countdownTimer); countdownTimer=null;}
        if(lx>=GAME_LEVELS.length){showResult(100,true);return;}
        gameLevel=lx+1; gameSequence=GAME_LEVELS[lx];
        document.getElementById('game-level').textContent=gameLevel;
        
        for(let i=0;i<GAME_STEPS;i++){
            const dc=document.getElementById(`g-demo-${i}`), pc=document.getElementById(`g-player-${i}`);
            dc.className=gameSequence[i]?"w-full h-12 rounded-lg border transition-all duration-100 cell-target-active":"w-full h-12 bg-slate-700 rounded-lg border border-slate-600";
            pc.className="w-full h-12 bg-slate-700 rounded-lg border border-slate-600 transition-all duration-100";
        }
        
        gamePhase='countdown';
        document.getElementById('game-tap-btn').disabled=true;
        document.getElementById('game-instruction').textContent="ãŠæ‰‹æœ¬ã‚’ãã„ã¦ã­";
        
        let c=3;
        document.getElementById('game-message').textContent=c;
        countdownTimer=setInterval(()=>{
            c--;
            if(c>0){document.getElementById('game-message').textContent=c;playOneShot('hihat');}
            else{clearInterval(countdownTimer);countdownTimer=null;document.getElementById('game-message').textContent="Listen!";playOneShot('clap');runDemoPhase();}
        },500);
    }

    function runDemoPhase(){
        gamePhase='demo';
        Tone.Transport.stop(); Tone.Transport.cancel();
        Tone.Transport.bpm.value=100;
        
        let s=0;
        Tone.Transport.scheduleRepeat((t)=>{
            if(s>=GAME_STEPS){Tone.Transport.stop();Tone.Transport.cancel();setTimeout(startInputCountdown,500);return;}
            Tone.Draw.schedule(()=>{
                if(s>0)document.getElementById(`g-demo-${s-1}`).classList.remove('cell-cursor');
                const c=document.getElementById(`g-demo-${s}`);c.classList.add('cell-cursor');
            },t);
            if(gameSequence[s]){synths.kick.triggerAttackRelease("C2","8n",t);}else{playOneShot('metro');}
            s++;
        },"8n");
        Tone.Transport.start();
    }

    function startInputCountdown(){
        document.getElementById('game-instruction').textContent="ã‚ãªãŸã®ç•ªã§ã™...";
        for(let i=0;i<GAME_STEPS;i++)document.getElementById(`g-demo-${i}`).classList.remove('cell-cursor');
        
        let c=3;
        document.getElementById('game-message').textContent=c;
        countdownTimer=setInterval(()=>{
            c--;
            if(c>0){document.getElementById('game-message').textContent=c;playOneShot('hihat');}
            else{clearInterval(countdownTimer);countdownTimer=null;document.getElementById('game-message').textContent="Go!";playOneShot('clap');runInputPhase();}
        },500);
    }

    function runInputPhase(){
        gamePhase='input'; gameUserPos=0; window.userInputs=Array(GAME_STEPS).fill(0);
        document.getElementById('game-instruction').textContent="ç™½ã„æ ã«ã‚ã‚ã›ã¦ TAPï¼";
        document.getElementById('game-tap-btn').disabled=false;

        Tone.Transport.stop(); Tone.Transport.cancel();
        
        let s=0;
        Tone.Transport.scheduleRepeat((t)=>{
            if(s>=GAME_STEPS){Tone.Transport.stop();Tone.Transport.cancel();setTimeout(evaluateGame,500);return;}
            gameUserPos=s;
            Tone.Draw.schedule(()=>{
                if(s>0)document.getElementById(`g-player-${s-1}`).classList.remove('cell-cursor');
                const c=document.getElementById(`g-player-${s}`);c.classList.add('cell-cursor');
            },t);
            playOneShot('metro');
            s++;
        },"8n");
        Tone.Transport.start();
    }

    function gameTap(){
        if(gamePhase!=='input')return;
        const c=document.getElementById(`g-player-${gameUserPos}`);
        if(c){
            // Check logic immediate feedback
            if(gameSequence[gameUserPos]===1) {
                c.classList.add('cell-hit-success');
                playOneShot('clap');
            } else {
                c.classList.add('cell-hit-fail');
                playOneShot('snare');
            }
            window.userInputs[gameUserPos]=1;
        }
    }

    function evaluateGame(){
        gamePhase='judge'; document.getElementById('game-tap-btn').disabled=true;
        let hits=0,misses=0,targets=0;
        for(let i=0;i<GAME_STEPS;i++){
            if(gameSequence[i]){targets++; if(window.userInputs[i])hits++;}
            else{if(window.userInputs[i])misses++;}
        }
        let score = targets>0 ? (hits/targets)*100 : 0;
        score -= (misses*10); if(score<0)score=0;
        showResult(score);
    }

    function showResult(s,all=false){
        const m=document.getElementById('game-result'), t=document.getElementById('result-title'), d=document.getElementById('result-desc'), i=document.getElementById('result-icon'), b=m.querySelector('button');
        m.classList.remove('hidden');
        if(all){i.textContent="military_tech";i.className="material-symbols-rounded text-8xl text-purple-400 mb-4 animate-bounce-sm";t.textContent="All Clear!";d.textContent="å…¨ã‚¯ãƒªãŠã‚ã§ã¨ã†ï¼";b.textContent="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸";b.onclick=exitGame;return;}
        if(s>=80){i.textContent="emoji_events";i.className="material-symbols-rounded text-8xl text-yellow-400 mb-4 animate-bounce-sm";t.textContent="Excellent!";d.textContent=`Score: ${Math.round(s)}ç‚¹`;b.textContent="ã¤ãã¸";b.onclick=()=>{m.classList.add('hidden');startLevel(gameLevel);}}
        else{i.textContent="sentiment_dissatisfied";i.className="material-symbols-rounded text-8xl text-slate-400 mb-4";t.textContent="Try Again...";d.textContent=`Score: ${Math.round(s)}ç‚¹`;b.textContent="ã‚‚ã†ã„ã¡ã©";b.onclick=()=>{m.classList.add('hidden');startLevel(gameLevel-1);}}
    }

    function exitGame(){
        gameActive=false;
        Tone.Transport.stop();Tone.Transport.cancel();
        if(countdownTimer){clearInterval(countdownTimer);countdownTimer=null;}
        document.getElementById('game-play').classList.add('hidden');
        document.getElementById('game-result').classList.add('hidden');
        document.getElementById('game-menu').classList.remove('hidden');
    }

    initGrid();
</script>

</body></html>

