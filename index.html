<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>ワンダー・スクール | デジタル研究室ポータル</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&amp;family=Zen+Maru+Gothic:wght@500;700;900&amp;display=swap" rel="stylesheet">
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@40,700,1,0" rel="stylesheet">
    <!-- Audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #F8FAFC;
            background-image: 
                radial-gradient(#E2E8F0 2px, transparent 2px),
                radial-gradient(#E2E8F0 2px, transparent 2px);
            background-size: 32px 32px;
            background-position: 0 0, 16px 16px;
            color: #334155;
            transition: font-size 0.3s ease;
        }

        .font-pop { font-family: 'M PLUS Rounded 1c', sans-serif; }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }

        @keyframes pop-in {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .shine-effect::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-25deg);
            animation: shine 3s infinite;
        }

        /* Utility for disabling animations */
        body.reduce-motion *, body.reduce-motion *::after, body.reduce-motion *::before {
            animation: none !important;
            transition: none !important;
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        /* Tab Active Styles */
        .tab-active {
            background-color: white;
            color: #3B82F6;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        /* Text Size Variants */
        body.text-large { font-size: 1.1rem; }
        body.text-large h1 { font-size: 1.5rem; }
        body.text-large h2 { font-size: 3.5rem; }
        body.text-large .app-card p { font-size: 1rem; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-x-hidden selection:bg-indigo-100 relative">
    
    <!-- LOGIN MODAL (Overlay) -->
    <!-- click outside logic included -->
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/90 backdrop-blur-sm p-4 transition-opacity duration-500 opacity-0 pointer-events-none" id="login-modal" style="display: none;">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl border-4 border-indigo-100 text-center relative overflow-hidden" onclick="event.stopPropagation()">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400"></div>
            <div class="mb-6 inline-block bg-indigo-50 p-4 rounded-full">
                <span class="material-symbols-rounded text-6xl text-indigo-500 animate-float">science</span>
            </div>
            <h1 class="text-3xl font-black text-slate-800 mb-2 font-pop">ワンダー・スクール</h1>
            <p class="text-slate-500 font-bold mb-8">デジタル研究室へ ようこそ！</p>
            
            <div class="space-y-4">
                <div class="text-left">
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">おなまえ (ニックネーム)</label>
                    <input type="text" id="user-name-input" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 focus:outline-none focus:border-indigo-400 focus:bg-white transition" placeholder="例: はかせ">
                </div>
                
                <div class="text-left">
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">アバターをえらんでね</label>
                    <div class="flex justify-between gap-2" id="avatar-selector">
                        <button class="avatar-option flex-1 bg-blue-50 hover:bg-blue-100 border-2 border-transparent hover:border-blue-300 rounded-xl p-2 transition group" data-avatar="face">
                            <span class="material-symbols-rounded text-3xl text-blue-500 group-hover:scale-110 transition">face</span>
                        </button>
                        <button class="avatar-option flex-1 bg-pink-50 hover:bg-pink-100 border-2 border-transparent hover:border-pink-300 rounded-xl p-2 transition group bg-indigo-100 border-indigo-400" data-avatar="sentiment_satisfied">
                            <span class="material-symbols-rounded text-3xl text-pink-500 group-hover:scale-110 transition">sentiment_satisfied</span>
                        </button>
                        <button class="avatar-option flex-1 bg-green-50 hover:bg-green-100 border-2 border-transparent hover:border-green-300 rounded-xl p-2 transition group" data-avatar="psychology">
                            <span class="material-symbols-rounded text-3xl text-green-500 group-hover:scale-110 transition">psychology</span>
                        </button>
                        <button class="avatar-option flex-1 bg-yellow-50 hover:bg-yellow-100 border-2 border-transparent hover:border-yellow-300 rounded-xl p-2 transition group" data-avatar="robot_2">
                            <span class="material-symbols-rounded text-3xl text-yellow-500 group-hover:scale-110 transition">robot_2</span>
                        </button>
                    </div>
                </div>

                <button onclick="enterLab()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-black py-4 rounded-xl shadow-lg transform active:scale-95 transition-all mt-4 flex items-center justify-center gap-2">
                    <span>研究をはじめる</span>
                    <span class="material-symbols-rounded">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="main-interface" class="flex-1 flex flex-col transition-opacity duration-500 opacity-100">
        
        <!-- Header -->
        <header class="bg-white/90 backdrop-blur-md border-b-2 border-slate-200 sticky top-0 z-40 shadow-sm">
            <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
                <!-- Logo -->
                <div class="flex items-center gap-2">
                    <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-2 rounded-xl shadow-md">
                        <span class="material-symbols-rounded text-2xl block">hub</span>
                    </div>
                    <div>
                        <h1 class="font-black text-slate-700 text-lg md:text-xl font-pop tracking-tight">ワンダー・スクール</h1>
                        <p class="text-[10px] text-slate-400 font-bold leading-none">デジタル研究室</p>
                    </div>
                </div>

                <!-- Right Side: Controls & Profile -->
                <div class="flex items-center gap-3">
                    <!-- Sound Toggle -->
                    <button id="main-sound-toggle" onclick="toggleMute()" class="bg-slate-100 hover:bg-slate-200 text-slate-500 p-2 rounded-full transition-colors relative group" title="音のオン/オフ">
                        <span id="sound-icon" class="material-symbols-rounded text-green-500">volume_up</span>
                        <span class="absolute -top-1 -right-1 flex h-3 w-3">
                            <span id="sound-ping" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75 hidden"></span>
                            <span id="sound-dot" class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                    </button>

                    <!-- DOWNLOAD BUTTON -->
                    <button onclick="downloadSource()" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-md hover:shadow-lg active:scale-95 transition-all">
                        <span class="material-symbols-rounded text-sm">download</span>
                        <span class="hidden md:inline">ソースを保存</span>
                    </button>

                    <!-- User Profile Badge -->
                    <div class="flex items-center gap-3 bg-slate-100 pr-4 pl-1 py-1 rounded-full border border-slate-200">
                        <div class="bg-white p-1.5 rounded-full shadow-sm">
                            <span id="header-avatar" class="material-symbols-rounded text-indigo-500">sentiment_satisfied</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[10px] font-bold text-slate-400 leading-none">研究員ID: 001</span>
                            <span id="header-username" class="text-sm font-black text-slate-700 leading-none">みかん</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 max-w-6xl mx-auto w-full p-4 md:p-6 pb-24">
            
            <!-- Grade Selector (Tabs) -->
            <nav class="flex justify-center mb-8 relative z-10">
                <div class="bg-slate-200/80 p-1.5 rounded-2xl flex gap-1 md:gap-2 shadow-inner overflow-x-auto max-w-full">
                    <button id="btn-low" onclick="setCategory('low')" class="px-4 py-2 rounded-xl font-bold text-sm md:text-base hover:text-slate-700 transition-all flex items-center gap-1.5 whitespace-nowrap min-w-[100px] justify-center text-slate-500">
                        <span class="material-symbols-rounded text-lg text-yellow-500">child_care</span>
                        小学校 低学年
                    </button>
                    <button id="btn-high" onclick="setCategory('high')" class="px-4 py-2 rounded-xl font-bold text-sm md:text-base hover:text-slate-700 transition-all flex items-center gap-1.5 whitespace-nowrap min-w-[100px] justify-center text-slate-500">
                        <span class="material-symbols-rounded text-lg text-orange-500">school</span>
                        小学校 高学年
                    </button>
                    <button id="btn-middle" onclick="setCategory('middle')" class="px-4 py-2 rounded-xl font-bold text-sm md:text-base hover:text-slate-700 transition-all flex items-center gap-1.5 whitespace-nowrap min-w-[100px] justify-center tab-active">
                        <span class="material-symbols-rounded text-lg text-indigo-500">menu_book</span>
                        中学生
                    </button>
                </div>
            </nav>

            <!-- Dynamic Hero Section -->
            <section id="hero-section" class="mb-10 transition-all duration-300">
                <div class="glass-panel rounded-3xl p-6 md:p-10 relative overflow-hidden group">
                    <!-- Hero Background Image (Generated) -->
                    <div class="absolute inset-0 z-0">
                        <img src="https://placehold.co/1280x720/e2e8f0/64748b?text=Lab+Background" alt="Lab Background" class="w-full h-full object-cover opacity-20 group-hover:scale-105 transition-transform duration-1000">
                    </div>
                    
                    <div class="relative z-10 flex flex-col md:flex-row items-center gap-6">
                        <div class="flex-1 text-center md:text-left">
                            <span id="hero-tag" class="inline-block px-3 py-1 rounded-full bg-indigo-100 text-indigo-600 text-xs font-black mb-3">中学生</span>
                            <h2 id="hero-title" class="text-3xl md:text-5xl font-black text-slate-800 mb-4 font-pop leading-tight">クリエイティブな<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-500">作品をつくろう</span></h2>
                            <p id="hero-desc" class="text-slate-600 font-bold text-lg mb-6">全てのラボを使って、自由な発想で作品を作り出そう。</p>
                        </div>
                        <div class="w-32 h-32 md:w-48 md:h-48 bg-white rounded-full shadow-2xl flex items-center justify-center animate-float border-4 border-indigo-100">
                            <span id="hero-icon" class="material-symbols-rounded text-6xl md:text-8xl text-indigo-400 js-replaced-missing-icon">radio_button_unchecked</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Apps Grid -->
            <section>
                <div class="flex items-center gap-2 mb-6 px-2">
                    <span class="material-symbols-rounded text-slate-400">apps</span>
                    <h3 id="grid-title" class="text-xl font-black text-slate-700">すべてのラボ (All Access)</h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <!-- APP 1: COLOR LAB -->
                    <div class="app-card group relative bg-white rounded-3xl shadow-lg border-2 border-slate-100 overflow-hidden hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 opacity-100 shine-effect" data-categories="low" style="display: block;">
                        <div class="h-40 overflow-hidden relative">
                            <img src="https://placehold.co/600x400/fbbf24/ffffff?text=Color+Lab" alt="Color Lab" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                            <div class="absolute top-3 left-3 bg-yellow-400 text-white text-xs font-black px-3 py-1 rounded-full shadow-md">図工・理科</div>
                            <div class="absolute top-3 right-3 bg-white/90 backdrop-blur text-slate-600 text-[10px] font-bold px-2 py-1 rounded-lg border border-slate-200">低学年〜</div>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-black text-slate-800 group-hover:text-yellow-500 transition-colors">いろのじっけんしつ DX</h3>
                                <span class="material-symbols-rounded text-yellow-400 text-3xl bg-yellow-50 p-1 rounded-lg">palette</span>
                            </div>
                            <!-- UPDATED: Text is now all hiragana/numbers for kids -->
                            <p class="text-sm text-slate-500 font-bold mb-6 min-h-[40px]">
                                3つの いろを まぜて、 あたらしい いろを つくろう！<br>いろの ふしぎを はっけん しよう！
                            </p>
                            <button onclick="launchApp('color-lab完成ver1.html', 'Color Lab')" class="w-full bg-slate-100 hover:bg-yellow-400 hover:text-white text-slate-600 font-black py-3 rounded-xl transition-all flex items-center justify-center gap-2 group-hover:shadow-md">
                                <span class="material-symbols-rounded">play_arrow</span>
                                じっけんを はじめる
                            </button>
                        </div>
                    </div>

                    <!-- APP 2: KANJI LAB -->
                    <div class="app-card group relative bg-white rounded-3xl shadow-lg border-2 border-slate-100 overflow-hidden hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 opacity-100 shine-effect" data-categories="high" style="display: block;">
                        <div class="h-40 overflow-hidden relative">
                            <!-- Corrected: Using Image Search for accurate Kanji Blocks -->
                            <img src="https://placehold.co/600x400/f97316/ffffff?text=Kanji+Lab" alt="Kanji Lab" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                            <div class="absolute top-3 left-3 bg-orange-500 text-white text-xs font-black px-3 py-1 rounded-full shadow-md">国語</div>
                            <div class="absolute top-3 right-3 bg-white/90 backdrop-blur text-slate-600 text-[10px] font-bold px-2 py-1 rounded-lg border border-slate-200">高学年〜</div>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-black text-slate-800 group-hover:text-orange-500 transition-colors">かんじ・ガッタイ・ラボ</h3>
                                <span class="material-symbols-rounded text-orange-400 text-3xl bg-orange-50 p-1 rounded-lg">extension</span>
                            </div>
                            <p class="text-sm text-slate-500 font-bold mb-6 min-h-[40px]">
                                へんとつくりを組み合わせて、漢字をつくろう！<br>パズル感覚で漢字マスターに。
                            </p>
                            <button onclick="launchApp('kanji-lab-v5.html', 'Kanji Lab')" class="w-full bg-slate-100 hover:bg-orange-500 hover:text-white text-slate-600 font-black py-3 rounded-xl transition-all flex items-center justify-center gap-2 group-hover:shadow-md">
                                <span class="material-symbols-rounded">play_arrow</span>
                                研究をはじめる
                            </button>
                        </div>
                    </div>

                    <!-- APP 3: RHYTHM STUDIO -->
                    <div class="app-card group relative bg-white rounded-3xl shadow-lg border-2 border-slate-100 overflow-hidden hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 opacity-100 shine-effect" data-categories="low,high,middle" style="display: block;">
                        <div class="h-40 overflow-hidden relative">
                            <img src="https://placehold.co/600x400/ec4899/ffffff?text=Rhythm+Lab" alt="Rhythm Lab" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                            <div class="absolute top-3 left-3 bg-pink-500 text-white text-xs font-black px-3 py-1 rounded-full shadow-md">音楽</div>
                            <div class="absolute top-3 right-3 bg-white/90 backdrop-blur text-slate-600 text-[10px] font-bold px-2 py-1 rounded-lg border border-slate-200">全学年</div>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-black text-slate-800 group-hover:text-pink-500 transition-colors">リズム・スタジオ</h3>
                                <span class="material-symbols-rounded text-pink-400 text-3xl bg-pink-50 p-1 rounded-lg">music_note</span>
                            </div>
                            <p class="text-sm text-slate-500 font-bold mb-6 min-h-[40px]">
                                好きな音をならべて、自分だけのリズムをつくろう。<br>音楽の楽しさを自由に体験しよう！
                            </p>
                            <button onclick="launchApp('rhythm-lab-final-fixed.html', 'Rhythm Lab')" class="w-full bg-slate-100 hover:bg-pink-500 hover:text-white text-slate-600 font-black py-3 rounded-xl transition-all flex items-center justify-center gap-2 group-hover:shadow-md">
                                <span class="material-symbols-rounded">play_arrow</span>
                                セッション開始
                            </button>
                        </div>
                    </div>

                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-slate-200 py-8 mt-auto">
            <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-slate-400 text-xs font-bold">
                    © 2025 Wonder School Digital Lab.
                </div>
                <div class="flex gap-4">
                    <button onclick="openSettings()" class="text-slate-400 hover:text-slate-600 text-xs font-bold flex items-center gap-1">
                        <span class="material-symbols-rounded text-sm">settings</span> 設定
                    </button>
                    <button onclick="openParentsModal()" class="text-slate-400 hover:text-slate-600 text-xs font-bold flex items-center gap-1">
                        <span class="material-symbols-rounded text-sm">info</span> 保護者の方へ
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- SETTINGS MODAL -->
    <!-- click outside close logic included -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 hidden" onclick="if(event.target === this) closeModal('settings-modal')">
        <div class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl animate-pop relative" onclick="event.stopPropagation()">
            <button onclick="closeModal('settings-modal')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <span class="material-symbols-rounded">close</span>
            </button>
            <h2 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-2">
                <span class="material-symbols-rounded text-slate-400">settings</span> 設定 (Settings)
            </h2>
            
            <div class="space-y-6">
                <!-- Sound -->
                <div>
                    <label class="block text-sm font-bold text-slate-500 mb-2">音量 (Sound)</label>
                    <div class="flex items-center gap-4">
                        <button onclick="toggleMute()" class="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200">
                            <span id="settings-mute-icon" class="material-symbols-rounded text-green-500">volume_up</span>
                        </button>
                        <input type="range" id="volume-slider" min="-40" max="0" value="-10" step="1" oninput="setVolume(this.value)" class="w-full accent-indigo-500">
                    </div>
                </div>

                <!-- Font Size -->
                <div>
                    <label class="block text-sm font-bold text-slate-500 mb-2">文字サイズ (Text Size)</label>
                    <div class="flex bg-slate-100 rounded-xl p-1">
                        <button id="text-normal" onclick="setTextSize('normal')" class="flex-1 py-1 rounded-lg text-sm font-bold bg-white shadow-sm text-indigo-600 transition-all">ふつう</button>
                        <button id="text-large" onclick="setTextSize('large')" class="flex-1 py-1 rounded-lg text-sm font-bold text-slate-400 hover:text-slate-600 transition-all">おおきく</button>
                    </div>
                </div>

                <!-- Motion -->
                <div>
                    <label class="block text-sm font-bold text-slate-500 mb-2">動きをへらす (Reduce Motion)</label>
                    <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <span class="text-xs text-slate-400 font-bold">アニメーションを停止</span>
                        <button id="motion-toggle" onclick="toggleMotion()" class="w-12 h-6 bg-slate-300 rounded-full relative transition-colors duration-300">
                            <div id="motion-knob" class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300"></div>
                        </button>
                    </div>
                </div>
                
                <!-- Reset Data (New Feature) -->
                <div class="pt-4 border-t border-slate-100">
                    <button onclick="resetUserData()" class="text-xs font-bold text-red-400 hover:text-red-600 flex items-center gap-1 mx-auto">
                        <span class="material-symbols-rounded text-sm">delete_forever</span> データをリセット (ログアウト)
                    </button>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button onclick="closeModal('settings-modal')" class="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold hover:bg-slate-700 transition">閉じる</button>
            </div>
        </div>
    </div>

    <!-- PARENTS MODAL -->
    <!-- click outside close logic included -->
    <div id="parents-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 hidden" onclick="if(event.target === this) closeModal('parents-modal')">
        <div class="bg-white rounded-3xl p-6 md:p-8 max-w-lg w-full shadow-2xl animate-pop relative max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <button onclick="closeModal('parents-modal')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <span class="material-symbols-rounded">close</span>
            </button>
            <div class="mb-6 border-b-2 border-indigo-100 pb-4">
                <h2 class="text-xl md:text-2xl font-black text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-rounded text-indigo-500">family_restroom</span> 保護者の方へ
                </h2>
                <p class="text-xs text-slate-400 font-bold mt-1">For Parents &amp; Guardians</p>
            </div>
            
            <div class="space-y-6 text-sm text-slate-600 leading-relaxed font-bold">
                <div>
                    <h3 class="text-indigo-600 font-black mb-2 flex items-center gap-2">
                        <span class="material-symbols-rounded text-base">school</span> このサイトのねらい
                    </h3>
                    <p>
                        「ワンダー・スクール」は、STEAM教育（科学・技術・工学・芸術・数学）の要素を取り入れたデジタル教材への入り口です。<br>
                        お子様が遊び感覚で「試行錯誤」を繰り返し、自ら発見する喜びを感じられるよう設計されています。
                    </p>
                </div>
                <div>
                    <h3 class="text-green-600 font-black mb-2 flex items-center gap-2">
                        <span class="material-symbols-rounded text-base">security</span> 安全性について
                    </h3>
                    <p>
                        当サイトおよび各ラボ（アプリ）は、すべてお客様のブラウザ内（ローカル環境）で動作します。<br>
                        <span class="bg-green-100 text-green-700 px-1 rounded">個人情報の収集・外部サーバーへの送信は一切行いません。</span><br>
                        安心してお子様に操作させていただけます。
                    </p>
                </div>
                <div>
                    <h3 class="text-orange-500 font-black mb-2 flex items-center gap-2">
                        <span class="material-symbols-rounded text-base">timer</span> ご利用にあたって
                    </h3>
                    <p>
                        長時間の画面注視を避けるため、30分に1回程度の休憩を推奨しています。<br>
                        また、ダウンロードしたHTMLファイルはインターネット接続がなくても動作するため、オフライン環境での学習にも最適です。
                    </p>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <p class="text-xs text-slate-500">
                        ※ 本サイトはデモ版であり、実際の教材内容はサンプルです。ご意見・ご要望がございましたら、フィードバックをお寄せください。
                    </p>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button onclick="closeModal('parents-modal')" class="bg-indigo-500 text-white px-8 py-3 rounded-xl font-black hover:bg-indigo-600 transition shadow-lg shadow-indigo-200">理解しました</button>
            </div>
        </div>
    </div>

    <!-- LAUNCHER OVERLAY -->
    <div id="launcher-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-white hidden">
        <div class="text-center animate-pop">
            <div class="relative w-24 h-24 mx-auto mb-6">
                <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin"></div>
                <span class="material-symbols-rounded text-4xl text-indigo-500 absolute inset-0 flex items-center justify-center animate-pulse">rocket_launch</span>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-2">ラボを準備中...</h2>
            <p id="launcher-text" class="text-slate-500 font-bold">Connecting to Color Lab...</p>
        </div>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        let isAudioStarted = false;
        let isMuted = false;

        async function startAudio() {
            if (!isAudioStarted) {
                await Tone.start();
                Tone.Destination.volume.value = -10; // Default volume
                isAudioStarted = true;
                updateSoundIcon();
            }
        }
        
        function toggleMute() {
            isMuted = !isMuted;
            Tone.Destination.mute = isMuted;
            updateSoundIcon();
            
            // Visual feedback
            const btn = document.getElementById('main-sound-toggle');
            if(!isMuted && isAudioStarted) {
                playSound('click');
                // Brief ping animation
                const ping = document.getElementById('sound-ping');
                ping.classList.remove('hidden');
                setTimeout(() => ping.classList.add('hidden'), 1000);
            }
        }

        function setVolume(val) {
            if(!isAudioStarted) return;
            Tone.Destination.volume.value = parseFloat(val);
            if(Tone.Destination.mute && val > -40) {
                isMuted = false;
                Tone.Destination.mute = false;
                updateSoundIcon();
            }
        }

        function updateSoundIcon() {
            const icons = document.querySelectorAll('#sound-icon, #settings-mute-icon');
            const dot = document.getElementById('sound-dot');
            
            icons.forEach(icon => {
                icon.textContent = isMuted ? 'volume_off' : 'volume_up';
                icon.className = isMuted ? 'material-symbols-rounded text-slate-300' : 'material-symbols-rounded text-green-500';
            });
            
            if(dot) {
                if(isMuted) dot.classList.add('hidden');
                else dot.classList.remove('hidden');
            }
        }

        function playSound(type) {
            if(!isAudioStarted || isMuted) return;
            const synth = new Tone.Synth().toDestination();
            const poly = new Tone.PolySynth().toDestination();
            
            switch(type) {
                case 'hover':
                    synth.volume.value = -20;
                    synth.triggerAttackRelease("C6", "32n");
                    break;
                case 'click':
                    synth.volume.value = -10;
                    synth.triggerAttackRelease("G5", "16n");
                    break;
                case 'success':
                    poly.volume.value = -10;
                    poly.triggerAttackRelease(["C5", "E5", "G5"], "8n");
                    break;
                case 'launch':
                    const membrane = new Tone.MembraneSynth().toDestination();
                    membrane.triggerAttackRelease("C2", "8n");
                    setTimeout(() => poly.triggerAttackRelease(["C4", "E4", "A4", "C5"], "4n"), 100);
                    break;
            }
        }

        // --- STATE MANAGEMENT & PERSISTENCE ---
        const STORAGE_KEY = 'wonder_school_profile_v1';
        let currentCategory = 'all';
        let userProfile = {
            name: 'ゲスト',
            avatar: 'face'
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check for saved profile
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try {
                    userProfile = JSON.parse(savedData);
                    
                    // Restore UI immediately
                    document.getElementById('header-username').textContent = userProfile.name;
                    document.getElementById('header-avatar').textContent = userProfile.avatar;
                    
                    // Skip login modal
                    const modal = document.getElementById('login-modal');
                    const main = document.getElementById('main-interface');
                    modal.style.display = 'none';
                    main.classList.remove('opacity-0', 'pointer-events-none');
                    main.classList.add('opacity-100');
                    
                    // Set default category
                    setCategory('low');
                } catch(e) {
                    console.error('Saved profile error:', e);
                }
            }

            // Avatar selection logic
            const avatarBtns = document.querySelectorAll('.avatar-option');
            avatarBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    avatarBtns.forEach(b => b.classList.remove('bg-indigo-100', 'border-indigo-400'));
                    e.currentTarget.classList.add('bg-indigo-100', 'border-indigo-400');
                    userProfile.avatar = e.currentTarget.dataset.avatar;
                    playSound('click');
                });
                btn.addEventListener('mouseenter', () => playSound('hover'));
            });

            // Set default avatar selection
            avatarBtns[0].click();
        });

        // --- MAIN FUNCTIONS ---

        function enterLab() {
            startAudio();
            playSound('success');
            
            const nameInput = document.getElementById('user-name-input');
            if(nameInput.value.trim()) {
                userProfile.name = nameInput.value.trim();
            }

            // Save to LocalStorage
            localStorage.setItem(STORAGE_KEY, JSON.stringify(userProfile));

            // Update UI with profile
            document.getElementById('header-username').textContent = userProfile.name;
            document.getElementById('header-avatar').textContent = userProfile.avatar;

            // Transition
            const modal = document.getElementById('login-modal');
            const main = document.getElementById('main-interface');
            
            modal.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                modal.style.display = 'none';
                main.classList.remove('opacity-0', 'pointer-events-none');
                main.classList.add('opacity-100');
                
                // Set default category (Low grade as starting point is friendly)
                setCategory('low'); 
            }, 500);
        }

        function resetUserData() {
            if(confirm('ほんとうに データを けしますか？ (ログアウト)')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload(); // Reload to show login screen
            }
        }

        function setCategory(cat) {
            playSound('click');
            currentCategory = cat;

            // Update Tabs
            const btns = {
                low: document.getElementById('btn-low'),
                high: document.getElementById('btn-high'),
                middle: document.getElementById('btn-middle')
            };

            // Reset all tabs
            Object.values(btns).forEach(b => {
                b.classList.remove('tab-active', 'bg-white', 'text-blue-600', 'shadow-md');
                b.classList.add('text-slate-500');
            });

            // Activate selected
            if(btns[cat]) {
                btns[cat].classList.add('tab-active');
                btns[cat].classList.remove('text-slate-500');
            }

            // Update Content based on Category
            updateHero(cat);
            filterApps(cat);
        }

        function updateHero(cat) {
            const title = document.getElementById('hero-title');
            const desc = document.getElementById('hero-desc');
            const icon = document.getElementById('hero-icon');
            const tag = document.getElementById('hero-tag');

            // Animation Reset
            const hero = document.getElementById('hero-section');
            hero.classList.add('opacity-50', 'scale-95');

            setTimeout(() => {
                switch(cat) {
                    case 'low':
                        tag.textContent = "1ねんせい 〜 3ねんせい";
                        tag.className = "inline-block px-3 py-1 rounded-full bg-yellow-100 text-yellow-600 text-xs font-black mb-3";
                        title.innerHTML = `いろ と おと で<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-yellow-500 to-green-500">あそぼう！</span>`;
                        desc.textContent = "「いろのじっけん」や「リズム・スタジオ」が おすすめだよ。";
                        icon.textContent = "palette";
                        icon.className = "material-symbols-rounded text-6xl md:text-8xl text-yellow-400";
                        break;
                    case 'high':
                        tag.textContent = "4年生 〜 6年生";
                        tag.className = "inline-block px-3 py-1 rounded-full bg-orange-100 text-orange-600 text-xs font-black mb-3";
                        title.innerHTML = `漢字 と 音楽制作 に<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500">挑戦！</span>`;
                        desc.textContent = "「漢字パズル」や 本格的な「リズム制作」にチャレンジしよう。";
                        icon.textContent = "extension";
                        icon.className = "material-symbols-rounded text-6xl md:text-8xl text-orange-400";
                        break;
                    case 'middle':
                        tag.textContent = "中学生";
                        tag.className = "inline-block px-3 py-1 rounded-full bg-indigo-100 text-indigo-600 text-xs font-black mb-3";
                        title.innerHTML = `クリエイティブな<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-500">作品をつくろう</span>`;
                        desc.textContent = "全てのラボを使って、自由な発想で作品を作り出そう。";
                        icon.textContent = "auto_awesome";
                        icon.className = "material-symbols-rounded text-6xl md:text-8xl text-indigo-400";
                        break;
                }
                hero.classList.remove('opacity-50', 'scale-95');
            }, 300);
        }

        function filterApps(cat) {
            const cards = document.querySelectorAll('.app-card');
            const gridTitle = document.getElementById('grid-title');

            gridTitle.textContent = cat === 'middle' ? "すべてのラボ (All Access)" : "おすすめのラボ";

            cards.forEach(card => {
                const categories = card.dataset.categories.split(',');
                // Middle schoolers see everything, otherwise filter
                if (cat === 'middle' || categories.includes(cat)) {
                    card.style.display = 'block';
                    // Add subtle highlight if strictly matching
                    if(categories.includes(cat)) {
                        card.classList.remove('opacity-60', 'grayscale');
                        card.classList.add('opacity-100', 'shine-effect');
                    } else {
                        // Show but dim slightly if not primary target (optional logic)
                        card.classList.add('opacity-100');
                    }
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function launchApp(filename, appName) {
            startAudio();
            playSound('launch');
            
            const overlay = document.getElementById('launcher-overlay');
            const text = document.getElementById('launcher-text');
            
            text.textContent = `Launching ${appName}...`;
            overlay.classList.remove('hidden');

            // Simulate loading time
            setTimeout(() => {
                // Open in new tab
                window.open(filename, '_blank');
                
                // Hide overlay after a bit
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 1000);
            }, 1500);
        }

        // --- MODAL & SETTINGS FUNCTIONS ---

        function openSettings() {
            playSound('click');
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function openParentsModal() {
            playSound('click');
            document.getElementById('parents-modal').classList.remove('hidden');
        }

        function closeModal(id) {
            playSound('click');
            document.getElementById(id).classList.add('hidden');
        }

        // Usability: Text Size
        function setTextSize(size) {
            playSound('click');
            const body = document.body;
            const btnNormal = document.getElementById('text-normal');
            const btnLarge = document.getElementById('text-large');

            if(size === 'large') {
                body.classList.add('text-large');
                btnLarge.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                btnLarge.classList.remove('text-slate-400');
                btnNormal.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                btnNormal.classList.add('text-slate-400');
            } else {
                body.classList.remove('text-large');
                btnNormal.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                btnNormal.classList.remove('text-slate-400');
                btnLarge.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                btnLarge.classList.add('text-slate-400');
            }
        }

        // Usability: Reduce Motion
        function toggleMotion() {
            playSound('click');
            const body = document.body;
            const toggle = document.getElementById('motion-toggle');
            const knob = document.getElementById('motion-knob');
            
            body.classList.toggle('reduce-motion');
            const isReduced = body.classList.contains('reduce-motion');
            
            if(isReduced) {
                toggle.classList.remove('bg-slate-300');
                toggle.classList.add('bg-indigo-500');
                knob.style.transform = 'translateX(24px)';
            } else {
                toggle.classList.add('bg-slate-300');
                toggle.classList.remove('bg-indigo-500');
                knob.style.transform = 'translateX(0)';
            }
        }

        function downloadSource() {
            playSound('click');
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'wonder-lab-portal.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>