<!DOCTYPE html>
<html lang="ja"><head>

<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<title>かんじ・ガッタイ・ラボ Ver.8</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- 日本語フォント: Zen Maru Gothic (丸ゴシック) & Yuji Syuku (筆文字風) -->
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&amp;family=Yuji+Syuku&amp;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@40,700,1,0" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #FFF7ED; /* Orange-50 */
            background-image: radial-gradient(#FDBA74 2px, transparent 2px);
            background-size: 32px 32px;
            color: #431407; /* Amber-950 */
        }
        .font-fude { font-family: 'Yuji Syuku', serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border: 4px solid #FED7AA; /* Orange-200 */
            box-shadow: 0 8px 0 #FDBA74; /* Orange-300 */
        }
        .kanji-part-btn {
            transition: all 0.1s;
            border-bottom: 4px solid #D1D5DB;
        }
        .kanji-part-btn:active {
            transform: translateY(2px);
            border-bottom: 0px solid transparent;
            margin-bottom: 4px;
        }
        .kanji-part-btn.selected {
            background-color: #FDBA74; color: white;
            border-color: #C2410C; border-bottom-width: 4px;
        }
        @keyframes pop-in {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            80% { transform: scale(1.1) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); }
        }
        .animate-pop-in { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.2s linear 3; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #FDBA74; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #EA580C; }
    </style></head>
<body class="min-h-screen flex flex-col selection:bg-orange-200">
<!-- Header -->
<header class="bg-white border-b-4 border-orange-200 px-4 py-3 flex justify-between items-center sticky top-0 z-30 shadow-sm">
<div class="flex items-center gap-2 md:gap-3">
<div class="bg-orange-500 text-white p-2 rounded-xl shadow-sm transform rotate-3">
<span class="material-symbols-rounded text-2xl block">extension</span>
</div>
<h1 class="text-lg md:text-2xl font-black tracking-wider text-orange-900">かんじ・ガッタイ・ラボ</h1>
</div>
<div class="flex gap-2">
<div class="flex bg-orange-50 p-1 rounded-xl border-2 border-orange-200 mr-1 md:mr-2">
<button class="px-3 py-1.5 md:px-4 rounded-lg text-xs md:text-sm font-bold text-slate-400 hover:text-slate-600 transition-all" id="tab-lab" onclick="switchTab('lab')">
<span class="flex items-center gap-1"><span class="material-symbols-rounded text-sm">science</span> つくる</span>
</button>
<button class="px-3 py-1.5 md:px-4 rounded-lg text-xs md:text-sm font-bold transition-all bg-white text-orange-600 shadow-sm" id="tab-game" onclick="switchTab('game')">
<span class="flex items-center gap-1"><span class="material-symbols-rounded text-sm">quiz</span> クイズ</span>
</button>
</div>
<button class="bg-amber-400 hover:bg-amber-500 text-white px-3 py-1.5 rounded-xl font-bold flex items-center gap-1 shadow-[0_3px_0_#b45309] active:shadow-none active:translate-y-1 transition-all text-xs md:text-sm" onclick="openHelp()">
<span class="material-symbols-rounded text-lg">help</span>
</button>
<button class="bg-emerald-400 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-xl font-bold flex items-center gap-1 shadow-[0_3px_0_#059669] active:shadow-none active:translate-y-1 transition-all text-xs md:text-sm" id="mute-btn" onclick="toggleMute()">
<span class="material-symbols-rounded text-lg" id="mute-icon">volume_up</span>
</button>
<button class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-xl font-bold flex items-center gap-1 shadow-[0_3px_0_#1e293b] active:shadow-none active:translate-y-1 transition-all text-xs md:text-sm" onclick="downloadSource()">
<span class="material-symbols-rounded text-lg">save</span>
</button>
</div>
</header>
<!-- Main Content -->
<main class="flex-1 w-full max-w-5xl mx-auto p-4 flex flex-col gap-6">
<!-- VIEW: LAB (つくる) -->
<div class="flex flex-col gap-6 w-full transition-opacity duration-300 hidden" id="view-lab">
<!-- Lab Mode Switcher -->
<div class="flex justify-center">
<div class="bg-white p-1 rounded-full border-2 border-orange-200 flex shadow-sm">
<button class="px-6 py-2 rounded-full text-sm font-bold transition-all bg-orange-100 text-orange-700 shadow-inner" id="mode-lr" onclick="setLabMode('lr')">へん・つくり (左右)</button>
<button class="px-6 py-2 rounded-full text-sm font-bold transition-all text-slate-500 hover:bg-slate-50" id="mode-ud" onclick="setLabMode('ud')">かんむり・あし (上下)</button>
</div>
</div>
<!-- Result Area -->
<div class="glass-panel w-full p-6 rounded-3xl flex flex-col items-center justify-center min-h-[220px] relative overflow-hidden bg-white">
<div class="absolute top-0 left-0 w-full h-4 bg-orange-100 border-b border-orange-200"></div>
<div class="absolute bottom-0 left-0 w-full h-4 bg-orange-100 border-t border-orange-200"></div>
<!-- The Kanji Stage -->
<div class="flex flex-col md:flex-row items-center gap-2 md:gap-6 relative z-10" id="stage-container">
<!-- Left + Right (Dynamically set by JS) -->
<div class="flex items-center gap-2 md:gap-4 transition-all" id="parts-container">
                    <div class="flex flex-col items-center">
                        <div class="w-28 h-28 md:w-32 md:h-32 border-4 border-dashed border-slate-300 rounded-3xl flex items-center justify-center bg-slate-50 text-slate-300 text-7xl font-fude" id="display-left">?</div>
                        <span class="text-xs font-bold text-slate-400 mt-2 bg-slate-100 px-2 py-1 rounded-full">へん (左)</span>
                    </div>
                    <span class="material-symbols-rounded text-5xl text-orange-300 animate-bounce">add</span>
                    <div class="flex flex-col items-center">
                        <div class="w-28 h-28 md:w-32 md:h-32 border-4 border-dashed border-slate-300 rounded-3xl flex items-center justify-center bg-slate-50 text-slate-300 text-7xl font-fude" id="display-right">?</div>
                        <span class="text-xs font-bold text-slate-400 mt-2 bg-slate-100 px-2 py-1 rounded-full">つくり (右)</span>
                    </div>
                </div>
<!-- Arrow -->
<span class="material-symbols-rounded text-6xl text-slate-300 rotate-90 md:rotate-0 my-2 md:my-0">arrow_forward</span>
<!-- Result -->
<div class="flex flex-col items-center">
<div class="relative group">
<div class="w-28 h-28 md:w-32 md:h-32 border-4 border-orange-200 rounded-3xl flex items-center justify-center bg-white shadow-xl transform transition-all" id="result-box">
<span class="text-7xl md:text-8xl font-fude text-slate-200" id="result-char">?</span>
</div>
<div class="absolute -top-6 -right-6 text-yellow-400 text-6xl opacity-0 transition" id="result-sparkle">✨</div>
</div>
<!-- Meaning -->
<div class="mt-2 text-center opacity-0 transition-opacity duration-500 min-h-[3rem]" id="result-info">
<h2 class="text-xl font-bold text-orange-600 leading-tight" id="result-reading">よみ</h2>
<p class="text-sm text-slate-500 font-medium bg-orange-50 px-3 py-1 rounded-lg inline-block border border-orange-100 mt-1" id="result-meaning">いみ</p>
</div>
</div>
</div>
<div class="absolute top-4 right-4">
<button class="text-slate-400 hover:text-orange-500 transition flex flex-col items-center gap-1" onclick="toggleCollection()">
<span class="material-symbols-rounded text-3xl">menu_book</span>
<span class="text-[10px] font-bold">ずかん</span>
</button>
</div>
</div>
<!-- Parts List -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="bg-white rounded-3xl p-4 shadow-lg border-2 border-orange-100">
<div class="flex items-center gap-2 mb-4 px-2">
<span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg"><span class="material-symbols-rounded" id="icon-p1">format_align_left</span></span>
<h3 class="font-black text-slate-700" id="label-p1">へん</h3>
</div>
<div class="grid grid-cols-5 gap-2" id="list-p1"></div>
</div>
<div class="bg-white rounded-3xl p-4 shadow-lg border-2 border-orange-100">
<div class="flex items-center gap-2 mb-4 px-2">
<span class="bg-red-100 text-red-600 p-1.5 rounded-lg"><span class="material-symbols-rounded" id="icon-p2">format_align_right</span></span>
<h3 class="font-black text-slate-700" id="label-p2">つくり</h3>
</div>
<div class="grid grid-cols-5 gap-2" id="list-p2"></div>
</div>
</div>
<div class="flex justify-center">
<button class="bg-gradient-to-b from-orange-400 to-orange-600 text-white px-12 py-4 rounded-full font-black text-2xl shadow-[0_6px_0_#9a3412] active:shadow-none active:translate-y-2 transition transform hover:scale-105 flex items-center gap-2" onclick="combineKanji()">
<span class="material-symbols-rounded text-3xl">science</span> がったい！
                </button>
</div>
</div>
<!-- VIEW: GAME -->
<div class="flex-col gap-6 w-full h-full min-h-[500px]" id="view-game">
<div class="w-full h-full flex flex-col items-center justify-center gap-8 py-12 animate-pop-in hidden" id="game-menu">
<div class="text-center">
<h2 class="text-4xl font-black text-orange-800 mb-4">かんじクイズ</h2>
<p class="text-slate-600 font-bold text-lg">あそびかたを えらんでね！<br><span class="text-sm font-normal">10問ごとに区切られていて、途中でやめても続きから遊べるよ！</span></p>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl px-4">
<button class="group bg-white hover:bg-orange-50 border-4 border-orange-400 rounded-3xl p-8 shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all text-left flex flex-col items-center relative overflow-hidden" onclick="startGame('combine')">
<div class="z-10 text-center">
<span class="bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-black mb-3 inline-block">全30もん</span>
<h3 class="text-3xl font-black text-orange-600 mb-2">がったい クイズ</h3>
<p class="text-slate-500 font-bold mb-4">「読み」と「意味」を見て、<br>漢字をつくろう！</p>
<div class="flex gap-2 justify-center text-slate-400 font-fude text-2xl">
<span>?</span> + <span>?</span> = <span class="text-orange-500">林</span>
</div>
<p class="mt-4 text-xs font-bold text-orange-400" id="progress-combine">つづきから: 1もんめ</p>
</div>
</button>
<button class="group bg-white hover:bg-blue-50 border-4 border-blue-400 rounded-3xl p-8 shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all text-left flex flex-col items-center relative overflow-hidden" onclick="startGame('decompose')">
<div class="z-10 text-center">
<span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-black mb-3 inline-block">全30もん</span>
<h3 class="text-3xl font-black text-blue-600 mb-2">ぶんかい クイズ</h3>
<p class="text-slate-500 font-bold mb-4">表示された漢字を<br>バラバラにしよう！</p>
<div class="flex gap-2 justify-center text-slate-400 font-fude text-2xl">
<span class="text-blue-500">林</span> = <span>?</span> + <span>?</span>
</div>
<p class="mt-4 text-xs font-bold text-blue-400" id="progress-decompose">つづきから: 1もんめ</p>
</div>
</button>
</div>
</div>
<div class="w-full max-w-3xl mx-auto flex-col gap-6" id="game-play">
<div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border-2 border-orange-100">
<button class="text-slate-400 hover:text-orange-500 font-bold flex items-center gap-1 text-sm" onclick="exitGame()">
<span class="material-symbols-rounded">arrow_back</span> セーブしてやめる
                    </button>
<div class="flex gap-4 text-sm font-bold">
<span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full">ステージ <span id="quiz-stage">1</span> / 3</span>
<span class="bg-orange-50 text-orange-600 px-3 py-1 rounded-full">もんだい <span id="quiz-num">1</span> / 10</span>
</div>
</div>
<div class="bg-white rounded-3xl p-8 text-center shadow-lg border-b-8 border-orange-200 relative overflow-hidden">
<p class="text-slate-400 font-bold mb-2 text-sm" id="quiz-instruction">この漢字をつくろう！</p>
<div class="min-h-[120px] flex flex-col items-center justify-center">
<div class="hidden" id="quiz-combine-display">
<p class="text-4xl md:text-5xl font-bold text-orange-600 mb-2" id="quiz-target-reading">?</p>
<p class="text-lg text-slate-500 bg-orange-50 px-4 py-1 rounded-lg inline-block" id="quiz-target-meaning">?</p>
</div>
<h2 class="text-6xl md:text-8xl font-fude text-slate-800 hidden" id="quiz-target-char">?</h2>
</div>
<div class="flex justify-center gap-4 mt-8" id="quiz-slots-container">
<!-- JS Generated -->
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="bg-white/80 p-4 rounded-2xl border-2 border-orange-100">
<p class="text-xs font-bold text-center text-blue-400 mb-2" id="quiz-label-left">へん (ひだり)</p>
<div class="grid grid-cols-4 gap-2" id="quiz-choices-left"></div>
</div>
<div class="bg-white/80 p-4 rounded-2xl border-2 border-orange-100">
<p class="text-xs font-bold text-center text-red-400 mb-2" id="quiz-label-right">つくり (みぎ)</p>
<div class="grid grid-cols-4 gap-2" id="quiz-choices-right"></div>
</div>
</div>
<div class="text-center mt-2">
<button class="bg-slate-300 text-white px-8 py-3 rounded-full font-bold text-xl cursor-not-allowed transition" disabled="" id="quiz-submit-btn" onclick="checkQuiz()">決定</button>
</div>
</div>
<div class="hidden absolute inset-0 bg-orange-900/90 z-50 flex flex-col items-center justify-center p-4 animate-pop-in" id="game-result">
<div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full">
<span class="material-symbols-rounded text-6xl mb-4 block" id="result-icon">check_circle</span>
<h2 class="text-3xl font-black text-slate-800 mb-2" id="result-title">せいかい！</h2>
<div class="text-6xl font-fude text-orange-600 mb-4" id="result-kanji"></div>
<div class="text-sm text-slate-500 mb-6 bg-orange-50 p-2 rounded-lg" id="result-detail"></div>
<button class="bg-orange-500 hover:bg-orange-600 text-white px-8 py-3 rounded-full font-bold shadow-lg w-full" id="result-btn" onclick="nextQuiz()">つぎへ</button>
</div>
</div>
<div class="hidden absolute inset-0 bg-yellow-500/90 z-50 flex flex-col items-center justify-center p-4 animate-pop-in" id="stage-clear">
<div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-md w-full">
<span class="material-symbols-rounded text-8xl text-yellow-400 mb-4 animate-bounce">military_tech</span>
<h2 class="text-4xl font-black text-orange-600 mb-4">ステージクリア！</h2>
<p class="text-xl font-bold text-slate-600 mb-8">おめでとう！<br>つぎのステージにすすむ？</p>
<div class="flex gap-4">
<button class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-600 px-4 py-3 rounded-xl font-bold transition" onclick="exitGame()">メニューへ</button>
<button class="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-xl font-bold shadow-lg transition" onclick="nextStage()">すすむ！</button>
</div>
</div>
</div>
</div>
</main>
<!-- Modals -->
<div class="fixed inset-0 bg-slate-900/50 z-50 hidden transition-opacity" id="collection-modal">
<div class="absolute right-0 top-0 bottom-0 w-full max-w-sm bg-white shadow-2xl p-6 flex flex-col transform transition-transform translate-x-full" id="collection-panel">
<div class="flex justify-between items-center mb-6">
<h2 class="text-xl font-black text-slate-700 flex items-center gap-2"><span class="material-symbols-rounded text-orange-500">menu_book</span> かんじ図鑑</h2>
<button class="bg-slate-100 hover:bg-slate-200 rounded-full p-1" onclick="toggleCollection()"><span class="material-symbols-rounded">close</span></button>
</div>
<div class="flex-1 overflow-y-auto grid grid-cols-3 gap-4 content-start p-2" id="collection-grid">
<div class="col-span-3 text-center text-slate-400 text-sm mt-10">まだ見つけた漢字はないよ。<br>ラボで新しい漢字を作ろう！</div>
</div>
</div>
</div>
<div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity" id="help-modal">
<div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-transform" id="help-content">
<div class="bg-amber-400 p-4 flex justify-between items-center">
<h2 class="text-xl font-black text-white flex items-center gap-2"><span class="material-symbols-rounded">school</span> あそびかた</h2>
<button class="bg-white/20 hover:bg-white/40 text-white rounded-full p-1 transition" onclick="closeHelp()"><span class="material-symbols-rounded">close</span></button>
</div>
<div class="p-6 space-y-6 text-slate-600">
<div class="flex gap-4">
<span class="material-symbols-rounded text-3xl text-blue-400">science</span>
<div><h3 class="font-bold text-slate-800">つくるモード</h3><p class="text-sm">2つのパーツを選んで「がったい」ボタンを押そう！左右や上下の組み合わせがあるよ！</p></div>
</div>
<div class="flex gap-4">
<span class="material-symbols-rounded text-3xl text-orange-400">quiz</span>
<div><h3 class="font-bold text-slate-800">クイズモード</h3><p class="text-sm">「がったい」と「ぶんかい」の2つのモードで遊べるよ！全30問、10問ごとのステージ制だよ。</p></div>
</div>
<div class="bg-orange-50 p-4 rounded-xl text-center">
<button class="bg-amber-500 text-white px-6 py-2 rounded-full font-bold shadow-sm" onclick="closeHelp()">わかった！</button>
</div>
</div>
</div>
</div>
<script>
(() => {
      const KANJI_LR = [
    { l: '木', r: '木', k: '林', y: 'はやし', m: '木がたくさんあるところ' },
    { l: '木', r: '公', k: '松', y: 'まつ', m: '一年中緑の木' },
    { l: '木', r: '白', k: '柏', y: 'かしわ', m: 'もちを包む葉の木' },
    { l: '木', r: '交', k: '校', y: 'こう', m: '学校（がっこう）' },
    { l: '木', r: '才', k: '材', y: 'ざい', m: '材料（ざいりょう）' },
    { l: '木', r: '村', k: '村', y: 'むら', m: '人が集まって住むところ' },
    { l: '木', r: '目', k: '相', y: 'あい', m: 'あいて、お互い' },
    { l: '木', r: '反', k: '板', y: 'いた', m: 'ひらたい木' },
    { l: '木', r: '風', k: '楓', y: 'かえで', m: '紅葉する木' },
    { l: '木', r: '毎', k: '梅', y: 'うめ', m: '春に咲く花' },
    { l: '日', r: '月', k: '明', y: 'あかるい', m: '光があって明るい' },
    { l: '日', r: '青', k: '晴', y: 'はれ', m: 'いい天気' },
    { l: '日', r: '寺', k: '時', y: 'じ', m: '時間（じかん）' },
    { l: '日', r: '音', k: '暗', y: 'くらい', m: '光がなくて暗い' },
    { l: '日', r: '免', k: '晩', y: 'ばん', m: '夜のこと' },
    { l: '日', r: '生', k: '星', y: 'ほし', m: '夜空に光るもの' },
    { l: '日', r: '西', k: '晒', y: 'さらし', m: '日光に当てる' },
    { l: '日', r: '光', k: '晃', y: 'あきら', m: 'あきらか、ひかり' },
    { l: '言', r: '吾', k: '語', y: 'ご', m: '言葉（ことば）' },
    { l: '言', r: '舌', k: '話', y: 'はなし', m: 'おしゃべりする' },
    { l: '言', r: '売', k: '読', y: 'よむ', m: '本を読む' },
    { l: '言', r: '十', k: '計', y: 'けい', m: '数えること' },
    { l: '言', r: '成', k: '誠', y: 'まこと', m: 'うそのない心' },
    { l: '言', r: '寺', k: '詩', y: 'し', m: 'うた、ポエム' },
    { l: '言', r: '己', k: '記', y: 'き', m: 'しるす、記録' },
    { l: '言', r: '身', k: '謝', y: 'しゃ', m: 'あやまる、感謝' },
    { l: '氵', r: '毎', k: '海', y: 'うみ', m: '広くて大きい海' },
    { l: '氵', r: '也', k: '池', y: 'いけ', m: '水がたまっているところ' },
    { l: '氵', r: '羊', k: '洋', y: 'よう', m: '西洋、広い海' },
    { l: '氵', r: '去', k: '法', y: 'ほう', m: '決まりごと' },
    { l: '氵', r: '可', k: '河', y: 'かわ', m: '大きな川' },
    { l: '氵', r: '少', k: '沙', y: 'すな', m: 'すな、いさご' },
    { l: '氵', r: '工', k: '江', y: 'え', m: '大きな川、入り江' },
    { l: '氵', r: '青', k: '清', y: 'きよい', m: 'きよらか、すんだ水' },
    { l: '土', r: '也', k: '地', y: 'ち', m: '地面（じめん）' },
    { l: '土', r: '成', k: '城', y: 'しろ', m: 'お殿様の家' },
    { l: '土', r: '寸', k: '寺', y: 'てら', m: 'お坊さんのいるところ' },
    { l: '土', r: '旦', k: '坦', y: 'たん', m: '平らな土地' },
    { l: '土', r: '方', k: '坊', y: 'ぼう', m: 'お坊さん' },
    { l: '亻', r: '本', k: '体', y: 'からだ', m: '人間のからだ' },
    { l: '亻', r: '木', k: '休', y: 'やすむ', m: '休憩する' },
    { l: '亻', r: '言', k: '信', y: 'しん', m: '信じること' },
    { l: '亻', r: '山', k: '仙', y: 'せん', m: '仙人' },
    { l: '亻', r: '動', k: '働', y: 'はたらく', m: '仕事をすること' },
    { l: '女', r: '子', k: '好', y: 'すき', m: '気に入っている' },
    { l: '女', r: '少', k: '妙', y: 'みょう', m: '不思議なこと' },
    { l: '女', r: '未', k: '妹', y: 'いもうと', m: '年下の女きょうだい' },
    { l: '女', r: '市', k: '姉', y: 'あね', m: '年上の女きょうだい' },
    { l: '口', r: '未', k: '味', y: 'あじ', m: 'おいしいかどうか' },
    { l: '口', r: '十', k: '叶', y: 'かなう', m: '願いが叶う' },
    { l: '口', r: '鳥', k: '鳴', y: 'なく', m: '鳥が鳴く' },
    { l: '魚', r: '青', k: '鯖', y: 'さば', m: '青い背中の魚' },
    { l: '魚', r: '羊', k: '鮮', y: 'せん', m: '新鮮な魚' },
    { l: '魚', r: '京', k: '鯨', y: 'くじら', m: '海に住む大きな哺乳類' },
    { l: '金', r: '十', k: '針', y: 'はり', m: 'ぬい針' },
    { l: '金', r: '同', k: '銅', y: 'どう', m: '赤っぽい金属' }
  ];

  const KANJI_UD = [
    { l: '宀', r: '女', k: '安', y: 'あん', m: 'やすい' },
    { l: '宀', r: '子', k: '字', y: 'じ', m: 'もじ' },
    { l: '竹', r: '合', k: '答', y: 'とう', m: 'こたえる' },
    { l: '竹', r: '寺', k: '等', y: 'とう', m: 'ひとしい' },
    { l: '雨', r: '田', k: '雷', y: 'らい', m: 'かみなり' },
    { l: '雨', r: '申', k: '電', y: 'でん', m: 'でんき' },
    { l: '穴', r: '工', k: '空', y: 'くう', m: 'そら' },
    { l: '广', r: '占', k: '店', y: 'みせ', m: 'お店' },
    { l: '广', r: '里', k: '庭', y: 'にわ', m: 'にわ' },
    { l: '艹', r: '昔', k: '暮', y: 'ぼ', m: 'くれる' },
    { l: '艹', r: '余', k: '茶', y: 'ちゃ', m: 'おちゃ' }
  ];

  const PARTS_L_LR = ['木', '日', '言', '氵', '土', '亻', '女', '口', '魚', '金'];
  const PARTS_R_LR = [...new Set(KANJI_LR.map(d => d.r))].sort();
  const PARTS_L_UD = ['宀', '竹', '雨', '穴', '广', '艹'];
  const PARTS_R_UD = [...new Set(KANJI_UD.map(d => d.r))].sort();

  // Added missing definitions
  const KANJI_ALL = [...KANJI_LR, ...KANJI_UD];
  const TOTAL_QUIZ = 30;
  const STAGE_SIZE = 10;
  let quizPools = {};
  let quizPool = [];
  let currentLabMode = 'lr';

  let currentQuizIndex = 0;
  let currentQuiz = null;
  let qL = null;
  let qR = null;
  let gameProgress = { combine: 0, decompose: 0 };

  async function playSound(type) {
    if (isMuted) return;
    if (!synth) { await Tone.start(); synth = new Tone.PolySynth().toDestination(); }
    if (type === 'select') synth.triggerAttackRelease('C5', '32n');
    if (type === 'combine') synth.triggerAttackRelease(['C4', 'E4', 'G4'], '8n');
    if (type === 'success') synth.triggerAttackRelease(['C5', 'E5', 'G5', 'C6'], '4n');
    if (type === 'fail') synth.triggerAttackRelease(['F3', 'C3'], '4n');
  }

  function toggleMute() {
    isMuted = !isMuted;
    const btn = document.getElementById('mute-btn');
    const icon = document.getElementById('mute-icon');
    if (isMuted) {
      icon.textContent = 'volume_off';
      btn.className = 'bg-slate-400 text-white px-3 py-1.5 rounded-xl font-bold flex items-center gap-1 shadow-inner transition-all text-xs md:text-sm';
    } else {
      icon.textContent = 'volume_up';
      btn.className = 'bg-emerald-400 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-xl font-bold flex items-center gap-1 shadow-[0_3px_0_#059669] active:shadow-none active:translate-y-1 transition-all text-xs md:text-sm';
    }
  }

  function downloadSource() {
    const html = document.documentElement.outerHTML;
    const blob = new Blob([html], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'kanji-lab-v8.html';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  function switchTab(t) {
    const l = document.getElementById('view-lab');
    const g = document.getElementById('view-game');
    const tl = document.getElementById('tab-lab');
    const tg = document.getElementById('tab-game');
    if (t === 'lab') {
      l.classList.remove('hidden'); g.classList.add('hidden');
      tl.className = 'px-3 py-1.5 md:px-4 rounded-lg text-xs md:text-sm font-bold transition-all bg-white text-orange-600 shadow-sm';
      tg.className = 'px-3 py-1.5 md:px-4 rounded-lg text-xs md:text-sm font-bold text-slate-400 hover:text-slate-600 transition-all';
    } else {
      l.classList.add('hidden'); g.classList.remove('hidden');
      tl.className = 'px-3 py-1.5 md:px-4 rounded-lg text-xs md:text-sm font-bold text-slate-400 hover:text-slate-600 transition-all';
      tg.className = 'px-3 py-1.5 md:px-4 rounded-lg text-xs md:text-sm font-bold transition-all bg-white text-orange-600 shadow-sm';
      exitGame();
    }
  }

  const hm = document.getElementById('help-modal');
  const hc = document.getElementById('help-content');
  function openHelp() {
    hm.classList.remove('hidden'); void hm.offsetWidth;
    hm.classList.remove('opacity-0');
    hc.classList.remove('scale-95'); hc.classList.add('scale-100');
  }
  function closeHelp() {
    hm.classList.add('opacity-0');
    hc.classList.remove('scale-100'); hc.classList.add('scale-95');
    setTimeout(() => hm.classList.add('hidden'), 300);
  }

  const cm = document.getElementById('collection-modal');
  const cp = document.getElementById('collection-panel');
  function toggleCollection() {
    if (cm.classList.contains('hidden')) {
      cm.classList.remove('hidden');
      setTimeout(() => cp.classList.remove('translate-x-full'), 10);
    } else {
      cp.classList.add('translate-x-full');
      setTimeout(() => cm.classList.add('hidden'), 300);
    }
  }

  function setLabMode(mode) {
    currentLabMode = mode;
    const mlr = document.getElementById('mode-lr');
    const mud = document.getElementById('mode-ud');
    if (mode === 'lr') {
      mlr.className = 'px-6 py-2 rounded-full text-sm font-bold transition-all bg-orange-100 text-orange-700 shadow-inner';
      mud.className = 'px-6 py-2 rounded-full text-sm font-bold transition-all text-slate-500 hover:bg-slate-50';
    } else {
      mud.className = 'px-6 py-2 rounded-full text-sm font-bold transition-all bg-orange-100 text-orange-700 shadow-inner';
      mlr.className = 'px-6 py-2 rounded-full text-sm font-bold transition-all text-slate-500 hover:bg-slate-50';
    }
    renderLabUI();
  }

  function renderLabUI() {
    const c1 = document.getElementById('list-p1');
    const c2 = document.getElementById('list-p2');
    const l1 = document.getElementById('label-p1');
    const l2 = document.getElementById('label-p2');
    const i1 = document.getElementById('icon-p1');
    const i2 = document.getElementById('icon-p2');
    const parts = document.getElementById('parts-container');
    c1.innerHTML = ''; c2.innerHTML = '';

    if (currentLabMode === 'lr') {
      parts.className = 'flex items-center gap-2 md:gap-4 transition-all';
      parts.innerHTML = `
        <div class="flex flex-col items-center">
          <div class="w-28 h-28 md:w-32 md:h-32 border-4 border-dashed border-slate-300 rounded-3xl flex items-center justify-center bg-slate-50 text-slate-300 text-7xl font-fude" id="display-left">?</div>
          <span class="text-xs font-bold text-slate-400 mt-2 bg-slate-100 px-2 py-1 rounded-full">へん (左)</span>
        </div>
        <span class="material-symbols-rounded text-5xl text-orange-300 animate-bounce">add</span>
        <div class="flex flex-col items-center">
          <div class="w-28 h-28 md:w-32 md:h-32 border-4 border-dashed border-slate-300 rounded-3xl flex items-center justify-center bg-slate-50 text-slate-300 text-7xl font-fude" id="display-right">?</div>
          <span class="text-xs font-bold text-slate-400 mt-2 bg-slate-100 px-2 py-1 rounded-full">つくり (右)</span>
        </div>
      `;
      l1.textContent = 'へん'; i1.textContent = 'format_align_left';
      l2.textContent = 'つくり'; i2.textContent = 'format_align_right';
      PARTS_L_LR.forEach(p => createBtn(p, 'left', c1));
      PARTS_R_LR.forEach(p => createBtn(p, 'right', c2));
    } else {
      parts.className = 'flex flex-col items-center gap-2 transition-all';
      parts.innerHTML = `
        <div class="flex flex-col items-center">
          <div class="w-28 h-14 md:w-32 md:h-16 border-4 border-dashed border-slate-300 rounded-xl flex items-center justify-center bg-slate-50 text-slate-300 text-4xl font-fude" id="display-left">?</div>
          <span class="text-[10px] font-bold text-slate-400 mt-1 bg-slate-100 px-2 py-0.5 rounded-full">かんむり (上)</span>
        </div>
        <span class="material-symbols-rounded text-3xl text-orange-300 animate-bounce">add</span>
        <div class="flex flex-col items-center">
          <div class="w-28 h-14 md:w-32 md:h-16 border-4 border-dashed border-slate-300 rounded-xl flex items-center justify-center bg-slate-50 text-slate-300 text-4xl font-fude" id="display-right">?</div>
          <span class="text-[10px] font-bold text-slate-400 mt-1 bg-slate-100 px-2 py-0.5 rounded-full">あし (下)</span>
        </div>
      `;
      l1.textContent = 'かんむり'; i1.textContent = 'vertical_align_top';
      l2.textContent = 'あし'; i2.textContent = 'vertical_align_bottom';
      PARTS_L_UD.forEach(p => createBtn(p, 'left', c1));
      PARTS_R_UD.forEach(p => createBtn(p, 'right', c2));
    }
    selectedL = null; selectedR = null; resetResult();
  }

  function createBtn(char, side, container) {
    const btn = document.createElement('button');
    btn.className = 'bg-white border-b-4 border-slate-200 rounded-xl h-12 md:h-14 text-2xl md:text-3xl font-fude hover:bg-orange-50 kanji-part-btn text-slate-700';
    btn.textContent = char;
    btn.onclick = () => selectPart(side, char, btn);
    container.appendChild(btn);
  }

  function selectPart(side, char, el) {
    playSound('select');
    const parent = side === 'left' ? document.getElementById('list-p1') : document.getElementById('list-p2');
    Array.from(parent.children).forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    const disp = document.getElementById(side === 'left' ? 'display-left' : 'display-right');
    disp.textContent = char;
    const clsLR = 'w-28 h-28 md:w-32 md:h-32 border-4 border-solid rounded-3xl flex items-center justify-center bg-white text-7xl font-fude';
    const clsUD = 'w-28 h-14 md:w-32 md:h-16 border-4 border-solid rounded-xl flex items-center justify-center bg-white text-4xl font-fude';
    if (side === 'left') {
      selectedL = char;
      disp.className = currentLabMode === 'lr' ? `${clsLR} border-blue-200 text-blue-600` : `${clsUD} border-blue-200 text-blue-600`;
    } else {
      selectedR = char;
      disp.className = currentLabMode === 'lr' ? `${clsLR} border-red-200 text-red-600` : `${clsUD} border-red-200 text-red-600`;
    }
    resetResult();
  }

  function resetResult() {
    const rc = document.getElementById('result-char');
    const rb = document.getElementById('result-box');
    const ri = document.getElementById('result-info');
    rc.textContent = '?';
    rc.className = 'text-7xl md:text-8xl font-fude text-slate-200';
    rb.className = 'w-28 h-28 md:w-32 md:h-32 border-4 border-orange-200 rounded-3xl flex items-center justify-center bg-white shadow-xl transform transition-all';
    ri.classList.add('opacity-0');
  }

  function combineKanji() {
    if (!selectedL || !selectedR) { playSound('fail'); return; }
    const match = KANJI_ALL.find(d => d.l === selectedL && d.r === selectedR);
    const rb = document.getElementById('result-box');
    const rc = document.getElementById('result-char');
    const ri = document.getElementById('result-info');
    if (match) {
      playSound('success');
      rc.textContent = match.k;
      rc.className = 'text-8xl md:text-9xl font-fude text-orange-600';
      rb.classList.add('border-orange-500', 'scale-110', 'animate-pop-in');
      document.getElementById('result-reading').textContent = match.y;
      document.getElementById('result-meaning').textContent = match.m;
      ri.classList.remove('opacity-0');
      const s = document.getElementById('result-sparkle');
      s.classList.remove('opacity-0');
      setTimeout(() => { rb.classList.remove('animate-pop-in'); s.classList.add('opacity-0'); }, 500);
      if (!col.has(match.k)) { col.add(match.k); updateCol(); }
    } else {
      playSound('fail');
      rb.classList.add('animate-shake');
      setTimeout(() => { rb.classList.remove('animate-shake'); }, 500);
      rc.textContent = '×';
      rc.className = 'text-8xl md:text-9xl font-fude text-slate-400';
    }
  }

  function updateCol() {
    const g = document.getElementById('collection-grid');
    if (col.size === 0) return;
    g.innerHTML = '';
    col.forEach(k => {
      const d = document.createElement('div');
      d.className = 'bg-white border-2 border-orange-100 rounded-xl h-20 flex items-center justify-center text-4xl font-fude text-orange-800 shadow-sm animate-pop-in';
      d.textContent = k;
      g.appendChild(d);
    });
  }

  function shuffle(arr) { return [...arr].sort(() => 0.5 - Math.random()); }

  function startGame(mode) {
    playSound('select');
    gameMode = mode;
    if (!quizPools[mode]) {
      quizPools[mode] = shuffle(KANJI_ALL).slice(0, TOTAL_QUIZ);
    }
    quizPool = quizPools[mode];
    currentQuizIndex = gameProgress[mode] || 0;
    if (currentQuizIndex >= quizPool.length) currentQuizIndex = 0;
    document.getElementById('game-menu').classList.add('hidden');
    document.getElementById('game-play').classList.remove('hidden');
    loadQuiz();
  }

  function loadQuiz() {
    if (quizPool.length === 0) {
      quizPool = shuffle(KANJI_ALL).slice(0, TOTAL_QUIZ);
      quizPools[gameMode] = quizPool;
      currentQuizIndex = 0;
    }
    if (currentQuizIndex >= quizPool.length) { exitGame(); return; }
    currentQuiz = quizPool[currentQuizIndex];
    const stage = Math.floor(currentQuizIndex / STAGE_SIZE) + 1;
    const num = (currentQuizIndex % STAGE_SIZE) + 1;
    document.getElementById('quiz-stage').textContent = stage;
    document.getElementById('quiz-num').textContent = num;
    document.getElementById('quiz-score').textContent = currentQuizIndex;

    qL = null; qR = null;
    const isUD = KANJI_UD.some(k => k.k === currentQuiz.k);
    document.getElementById('quiz-label-left').textContent = isUD ? 'かんむり (上)' : 'へん (ひだり)';
    document.getElementById('quiz-label-right').textContent = isUD ? 'あし (下)' : 'つくり (みぎ)';

    const btn = document.getElementById('quiz-submit-btn');
    btn.disabled = true;
    btn.className = 'bg-slate-300 text-white px-8 py-3 rounded-full font-bold text-xl cursor-not-allowed transition';

    const dispCombine = document.getElementById('quiz-combine-display');
    const dispDecompose = document.getElementById('quiz-target-char');
    if (gameMode === 'combine') {
      dispCombine.classList.remove('hidden'); dispDecompose.classList.add('hidden');
      document.getElementById('quiz-instruction').textContent = '「よみ」と「いみ」から漢字をつくろう！';
      document.getElementById('quiz-target-reading').textContent = currentQuiz.y;
      document.getElementById('quiz-target-meaning').textContent = currentQuiz.m;
    } else {
      dispCombine.classList.add('hidden'); dispDecompose.classList.remove('hidden');
      document.getElementById('quiz-instruction').textContent = 'この漢字をバラバラにしよう！';
      dispDecompose.textContent = currentQuiz.k;
    }

    const sourcePool = isUD ? KANJI_UD : KANJI_LR;
    const allL = [...new Set(sourcePool.map(d => d.l))];
    const allR = [...new Set(sourcePool.map(d => d.r))];
    const choicesL = shuffle([currentQuiz.l, ...shuffle(allL.filter(p => p !== currentQuiz.l)).slice(0, 3)]);
    const choicesR = shuffle([currentQuiz.r, ...shuffle(allR.filter(p => p !== currentQuiz.r)).slice(0, 3)]);
    renderQuizChoices('left', choicesL);
    renderQuizChoices('right', choicesR);
    updateQuizSlotsDisplay(isUD);
  }

  function renderQuizChoices(side, chars) {
    const container = document.getElementById(`quiz-choices-${side}`);
    container.innerHTML = '';
    chars.forEach(c => {
      const b = document.createElement('button');
      b.className = 'bg-slate-50 border-2 border-slate-200 rounded-lg h-12 text-xl font-fude text-slate-600 hover:bg-orange-50 transition active:scale-95';
      b.textContent = c;
      b.onclick = () => selectQuizPart(side, c, b);
      container.appendChild(b);
    });
  }

  function selectQuizPart(side, char, btn) {
    playSound('select');
    const container = document.getElementById(`quiz-choices-${side}`);
    Array.from(container.children).forEach(el => el.className = 'bg-slate-50 border-2 border-slate-200 rounded-lg h-12 text-xl font-fude text-slate-600 hover:bg-orange-50 transition active:scale-95');
    btn.className = 'bg-orange-100 border-2 border-orange-400 rounded-lg h-12 text-xl font-fude text-orange-800 shadow-sm transform scale-105 transition';
    if (side === 'left') qL = char; else qR = char;
    const isUD = KANJI_UD.some(k => k.k === currentQuiz.k);
    updateQuizSlotsDisplay(isUD);
  }

  function updateQuizSlotsDisplay(isUD) {
    const sl = document.getElementById('quiz-slot-left');
    const sr = document.getElementById('quiz-slot-right');
    const base = isUD ? 'w-24 h-12 border-4 rounded-xl flex items-center justify-center text-3xl font-fude' : 'w-20 h-20 border-4 rounded-2xl flex items-center justify-center text-4xl font-fude';
    const container = document.getElementById('quiz-slots-container');
    container.className = isUD ? 'flex flex-col items-center gap-2 mt-6' : 'flex justify-center gap-4 mt-8';
    sl.textContent = qL || '?';
    sr.textContent = qR || '?';
    sl.className = qL ? `${base} border-solid border-blue-300 bg-blue-50 text-blue-800` : `${base} border-dashed border-slate-300 bg-slate-50 text-slate-300`;
    sr.className = qR ? `${base} border-solid border-red-300 bg-red-50 text-red-800` : `${base} border-dashed border-slate-300 bg-slate-50 text-slate-300`;
    if (qL && qR) {
      const b = document.getElementById('quiz-submit-btn');
      b.disabled = false;
      b.className = 'bg-orange-500 hover:bg-orange-600 text-white px-8 py-3 rounded-full font-bold text-xl shadow-lg transition transform active:scale-95';
    }
  }

  function checkQuiz() {
    const modal = document.getElementById('game-result');
    const title = document.getElementById('result-title');
    const icon = document.getElementById('result-icon');
    const kanji = document.getElementById('result-kanji');
    const detail = document.getElementById('result-detail');
    const btn = document.getElementById('result-btn');
    modal.classList.remove('hidden');

    if (qL === currentQuiz.l && qR === currentQuiz.r) {
      playSound('success');
      icon.textContent = 'check_circle';
      icon.className = 'material-symbols-rounded text-6xl mb-4 block text-green-500 animate-bounce';
      title.textContent = 'せいかい！';
      kanji.textContent = currentQuiz.k;
      kanji.className = 'text-6xl font-fude text-orange-600 mb-4';
      detail.textContent = `${currentQuiz.y} - ${currentQuiz.m}`;
      btn.textContent = 'つぎへ';
    } else {
      playSound('fail');
      icon.textContent = 'cancel';
      icon.className = 'material-symbols-rounded text-6xl mb-4 block text-red-500 animate-shake';
      title.textContent = 'ざんねん...';
      kanji.textContent = currentQuiz.k;
      kanji.className = 'text-6xl font-fude text-slate-600 mb-4';
      detail.textContent = `正解は [ ${currentQuiz.l} ] + [ ${currentQuiz.r} ] でした`;
      btn.textContent = 'つぎへ';
    }
    currentQuizIndex++;
    gameProgress[gameMode] = currentQuizIndex;
    updateMenuProgress();
  }

  function maybeShowStageClear() {
    const stageClear = document.getElementById('stage-clear');
    const atBoundary = currentQuizIndex > 0 && currentQuizIndex % STAGE_SIZE === 0 && currentQuizIndex < quizPool.length && currentQuizIndex < TOTAL_QUIZ;
    if (stageClear && atBoundary) {
      stageClear.classList.remove('hidden');
      return true;
    }
    return false;
  }

  function nextQuiz() {
    document.getElementById('game-result').classList.add('hidden');
    if (currentQuizIndex >= quizPool.length || currentQuizIndex >= TOTAL_QUIZ) {
      alert('全問クリア！おつかれさま！');
      gameProgress[gameMode] = 0;
      quizPools[gameMode] = null;
      exitGame();
      return;
    }
    if (maybeShowStageClear()) return;
    loadQuiz();
  }

  function nextStage() {
    const stageClear = document.getElementById('stage-clear');
    if (stageClear) stageClear.classList.add('hidden');
    if (currentQuizIndex >= quizPool.length || currentQuizIndex >= TOTAL_QUIZ) {
      alert('全問クリア！おつかれさま！');
      gameProgress[gameMode] = 0;
      quizPools[gameMode] = null;
      exitGame();
      return;
    }
    loadQuiz();
  }

  function exitGame() {
    document.getElementById('game-play').classList.add('hidden');
    document.getElementById('game-result').classList.add('hidden');
    const stageClear = document.getElementById('stage-clear');
    if (stageClear) stageClear.classList.add('hidden');
    document.getElementById('game-menu').classList.remove('hidden');
    updateMenuProgress();
  }

  function updateMenuProgress() {
    document.getElementById('progress-combine').textContent = `つづきから: ${gameProgress.combine + 1}もんめ`;
    document.getElementById('progress-decompose').textContent = `つづきから: ${gameProgress.decompose + 1}もんめ`;
  }

  renderLabUI();
  updateMenuProgress();
})();
</script>

</body></html>













